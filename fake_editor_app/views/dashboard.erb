<div class="dashboard">
  <h2>Dashboard d'Authentification</h2>

  <% if @completed_market_identifier %>
    <div class="alert alert-success">
      <strong>üéâ Configuration termin√©e!</strong> 
      Le march√© <code><%= @completed_market_identifier %></code> a √©t√© configur√© avec succ√®s dans Voie Rapide.
      La synchronisation par webhook devrait avoir mis √† jour son statut ci-dessous.
    </div>
  <% end %>

  <% if @error %>
    <div class="alert alert-error">
      <strong>Erreur:</strong> <%= @error %>
    </div>
  <% end %>

  <% if @success %>
    <div class="alert alert-success">
      <strong>Succ√®s:</strong> <%= @success %>
    </div>
  <% end %>

  <% if @configuration_url %>
    <div class="alert alert-info">
      <strong>URL de configuration:</strong> 
      <a href="<%= @configuration_url %>" target="_blank" class="config-link">
        <%= @configuration_url %>
      </a>
      <br>
      <em>Cliquez sur le lien pour acc√©der √† la page de configuration</em>
    </div>
  <% end %>

  <div class="config-section">
    <h3>Configuration</h3>
    <div class="config-item">
      <strong>Fast Track URL:</strong> <%= ENV['FAST_TRACK_URL'] %>
    </div>
    <div class="config-item">
      <strong>Client ID:</strong> <%= ENV['CLIENT_ID'] %>
    </div>
    <div class="config-item">
      <strong>Client Secret:</strong> <%= ENV['CLIENT_SECRET'] ? '***' + ENV['CLIENT_SECRET'][-4..-1] : 'Non configur√©' %>
    </div>
  </div>

  <div class="token-section">
    <h3>Statut d'Authentification</h3>
    
    <% if @current_token %>
      <div class="token-info">
        <div class="status-badge status-success">
          ‚úÖ Authentifi√©
        </div>
        
        <div class="token-details">
          <div class="token-field">
            <strong>Token:</strong>
            <code class="token-display"><%= @current_token.access_token[0..20] %>...</code>
          </div>
          
          <div class="token-field">
            <strong>Type:</strong> <%= @current_token.token_type %>
          </div>
          
          <div class="token-field">
            <strong>Scope:</strong> <%= @current_token.scope %>
          </div>
          
          <div class="token-field">
            <strong>Cr√©√© le:</strong> <%= @current_token.created_at.strftime('%d/%m/%Y √† %H:%M:%S') %>
          </div>
          
          <div class="token-field">
            <strong>Expire le:</strong> <%= @current_token.expires_at.strftime('%d/%m/%Y √† %H:%M:%S') %>
          </div>
          
          <div class="token-field">
            <strong>Statut:</strong> 
            <% if @current_token.valid? %>
              <span class="status-valid">‚úÖ Valide (expire dans <%= @current_token.time_until_expiry %>s)</span>
            <% else %>
              <span class="status-expired">‚ùå Expir√©</span>
            <% end %>
          </div>
        </div>
      </div>
    <% else %>
      <div class="token-info">
        <div class="status-badge status-error">
          ‚ùå Non authentifi√©
        </div>
        <p>Aucun token d'acc√®s disponible.</p>
      </div>
    <% end %>
  </div>

  <div class="actions-section">
    <h3>Actions</h3>
    
    <% if @current_token && @current_token.valid? %>
      <form method="post" action="/refresh" class="inline-form">
        <button type="submit" class="btn btn-primary">
          üîÑ Rafra√Æchir le Token
        </button>
      </form>
      
      <div class="market-form-section">
        <h4>Cr√©er un March√© Public</h4>
        <form method="post" action="/create_market" class="market-form">
          <div class="form-group">
            <label for="name">Nom du march√© <span class="required">*</span></label>name
            <input type="text" id="name" name="name" required 
                   placeholder="ex: Fourniture de mat√©riels informatiques">
          </div>
          
          <div class="form-group">
            <label for="lot_name">Nom du lot (optionnel)</label>
            <input type="text" id="lot_name" name="lot_name" 
                   placeholder="ex: Consommables informatiques">
          </div>
          
          <div class="form-group">
            <label for="deadline">Date et heure limite <span class="required">*</span></label>
            <input type="datetime-local" id="deadline" name="deadline" required>
          </div>
          
          <div class="form-group">
            <label for="market_type_codes">Typologie de march√© <span class="required">*</span></label>
            <select id="market_type_codes" name="market_type_codes[]" multiple required style="height: 120px;">
              <option value="supplies">Fournitures</option>
              <option value="services">Services</option>
              <option value="works">Travaux</option>
              <option value="defense">D√©fense et s√©curit√©</option>
            </select>
            <small style="display: block; margin-top: 5px; color: #666;">Maintenez Ctrl/Cmd pour s√©lectionner plusieurs typologies</small>
          </div>
          
          <button type="submit" class="btn btn-success">
            üöÄ Cr√©er le March√© Public
          </button>
        </form>
      </div>
    <% else %>
      <form method="post" action="/authenticate" class="inline-form">
        <button type="submit" class="btn btn-success">
          üîë S'authentifier
        </button>
      </form>
    <% end %>
    
    <form method="get" action="/clear" class="inline-form">
      <button type="submit" class="btn btn-danger">
        üóëÔ∏è Effacer les Tokens
      </button>
    </form>
  </div>

  <div class="markets-section">
    <h3>March√©s Publics Cr√©√©s</h3>
    
    <% if @markets&.any? %>
      <table class="markets-table">
        <thead>
          <tr>
            <th>Identifiant</th>
            <th>Nom</th>
            <th>Lot</th>
            <th>Candidatures</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @markets.each do |market| %>
            <tr class="<%= market.status %> market-row" data-identifier="<%= market.identifier %>">
              <td><code><%= market.identifier %></code></td>
              <td><%= market.name %></td>
              <td><%= market.lot_name || '-' %></td>
              <td>
                <span class="badge">
                  <%= market.completed_applications_count %>/<%= market.applications_count %>
                </span>
              </td>
              <td>
                <span class="status-badge status-<%= market.status %>">
                  <%= market.status == 'completed' ? '‚úÖ Configur√©' : '‚è≥ En attente' %>
                </span>
              </td>
              <td>
                <% if market.status == 'completed' %>
                  <a href="/markets/<%= market.identifier %>" class="btn btn-small">
                    Voir d√©tails ‚Üí
                  </a>
                <% else %>
                  <a href="<%= ENV['FAST_TRACK_URL'] %>/buyer/public_markets/<%= market.identifier %>/setup" 
                     target="_blank" class="btn btn-small btn-primary">
                    Configurer
                  </a>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="empty-state">Aucun march√© cr√©√© pour le moment.</p>
    <% end %>
  </div>

  <div class="instructions-section">
    <h3>Instructions</h3>
    <ol>
      <li>Assurez-vous que <strong>Voie Rapide</strong> est lanc√© sur <code><%= ENV['FAST_TRACK_URL'] %></code></li>
      <li>Cliquez sur <strong>"S'authentifier"</strong> pour obtenir un token OAuth2</li>
      <li>Une fois authentifi√©, cr√©ez un march√© public avec le formulaire</li>
      <li>Cliquez sur l'URL de configuration pour configurer le march√©</li>
      <li>Compl√©tez la configuration - le march√© appara√Ætra comme "Termin√©" via webhook</li>
    </ol>
    
    <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-left: 3px solid #0066cc;">
      <strong>üîó Webhook Endpoint:</strong> <code>POST /webhooks/voie-rapide</code><br>
      <small>Pr√™t √† recevoir les notifications de completion de Voie Rapide</small>
    </div>
  </div>
</div>
