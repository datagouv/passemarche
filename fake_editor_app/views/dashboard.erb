<div class="fr-mb-4w">
  <h1>Dashboard d'Authentification</h1>

  <% if @completed_market_identifier %>
    <div class="fr-alert fr-alert--success fr-mb-4w">
      <h3 class="fr-alert__title">Configuration termin√©e!</h3>
      <p>Le march√© <code><%= @completed_market_identifier %></code> a √©t√© configur√© avec succ√®s dans Voie Rapide.
      La synchronisation par webhook devrait avoir mis √† jour son statut ci-dessous.</p>
    </div>
  <% end %>

  <% if @error %>
    <div class="fr-alert fr-alert--error fr-mb-4w">
      <h3 class="fr-alert__title">Erreur</h3>
      <p><%= @error %></p>
    </div>
  <% end %>

  <% if @success %>
    <div class="fr-alert fr-alert--success fr-mb-4w">
      <h3 class="fr-alert__title">Succ√®s</h3>
      <p><%= @success %></p>
    </div>
  <% end %>

  <% if @configuration_url %>
    <div class="fr-alert fr-alert--info fr-mb-4w">
      <h3 class="fr-alert__title">URL de configuration</h3>
      <p><a href="<%= @configuration_url %>" target="_blank" class="fr-link" rel="noopener external">
        <%= @configuration_url %>
      </a></p>
      <p><em>Cliquez sur le lien pour acc√©der √† la page de configuration</em></p>
    </div>
  <% end %>

  <div class="fr-card fr-mb-4w">
    <div class="fr-card__body">
      <div class="fr-card__content">
        <h2 class="fr-card__title">Configuration</h2>
        <div class="fr-grid-row fr-grid-row--gutters">
          <div class="fr-col-12">
            <p><strong>Fast Track URL:</strong> <%= ENV['FAST_TRACK_URL'] %></p>
            <p><strong>Client ID:</strong> <%= ENV['CLIENT_ID'] %></p>
            <p><strong>Client Secret:</strong> <%= ENV['CLIENT_SECRET'] ? '***' + ENV['CLIENT_SECRET'][-4..-1] : 'Non configur√©' %></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="fr-card fr-mb-4w">
    <div class="fr-card__body">
      <div class="fr-card__content">
        <h2 class="fr-card__title">Statut d'Authentification</h2>
    
    <% if @current_token %>
        <div class="fr-mb-3w">
          <div class="fr-badge fr-badge--success fr-mb-2w">
            ‚úÖ Authentifi√©
          </div>
        
          <div class="fr-grid-row fr-grid-row--gutters">
            <div class="fr-col-12">
              <p><strong>Token:</strong> <code><%= @current_token.access_token[0..20] %>...</code></p>
              <p><strong>Type:</strong> <%= @current_token.token_type %></p>
              <p><strong>Scope:</strong> <%= @current_token.scope %></p>
              <p><strong>Cr√©√© le:</strong> <%= @current_token.created_at.strftime('%d/%m/%Y √† %H:%M:%S') %></p>
              <p><strong>Expire le:</strong> <%= @current_token.expires_at.strftime('%d/%m/%Y √† %H:%M:%S') %></p>
              <p><strong>Statut:</strong>
                <% if @current_token.valid? %>
                  <span class="fr-badge fr-badge--success">‚úÖ Valide (expire dans <%= @current_token.time_until_expiry %>s)</span>
                <% else %>
                  <span class="fr-badge fr-badge--error">‚ùå Expir√©</span>
                <% end %>
              </p>
            </div>
          </div>
        </div>
      <% else %>
        <div class="fr-mb-3w">
          <div class="fr-badge fr-badge--error fr-mb-2w">
            ‚ùå Non authentifi√©
          </div>
          <p>Aucun token d'acc√®s disponible.</p>
        </div>
      <% end %>
      </div>
    </div>
  </div>

  <div class="fr-card fr-mb-4w">
    <div class="fr-card__body">
      <div class="fr-card__content">
        <h2 class="fr-card__title">Actions</h2>
    
        <% if @current_token && @current_token.valid? %>
          <div class="fr-mb-3w">
            <form method="post" action="/refresh">
              <button type="submit" class="fr-btn fr-btn--secondary">
                üîÑ Rafra√Æchir le Token
              </button>
            </form>
          </div>
      
          <div class="fr-card fr-card--grey fr-p-4w">
            <h3>Cr√©er un March√© Public</h3>
            <form method="post" action="/create_market">
              <div class="fr-input-group">
                <label class="fr-label" for="name">Nom du march√© <span aria-hidden="true">*</span></label>
                <input class="fr-input" type="text" id="name" name="name" required 
                       placeholder="ex: Fourniture de mat√©riels informatiques">
              </div>
          
              <div class="fr-input-group">
                <label class="fr-label" for="lot_name">Nom du lot (optionnel)</label>
                <input class="fr-input" type="text" id="lot_name" name="lot_name" 
                       placeholder="ex: Consommables informatiques">
              </div>
          
              <div class="fr-input-group">
                <label class="fr-label" for="deadline">Date et heure limite <span aria-hidden="true">*</span></label>
                <input class="fr-input" type="datetime-local" id="deadline" name="deadline" required>
              </div>
          
              <div class="fr-select-group">
                <label class="fr-label" for="market_type_codes">Typologie de march√© <span aria-hidden="true">*</span></label>
                <select class="fr-select" id="market_type_codes" name="market_type_codes[]" multiple required style="height: 120px;">
                  <option value="supplies">Fournitures</option>
                  <option value="services">Services</option>
                  <option value="works">Travaux</option>
                  <option value="defense">D√©fense et s√©curit√©</option>
                </select>
                <div class="fr-hint-text">Maintenez Ctrl/Cmd pour s√©lectionner plusieurs typologies</div>
              </div>
          
              <button type="submit" class="fr-btn fr-btn--primary">
                üöÄ Cr√©er le March√© Public
              </button>
            </form>
          </div>
        <% else %>
          <div class="fr-mb-3w">
            <form method="post" action="/authenticate">
              <button type="submit" class="fr-btn fr-btn--primary">
                üîë S'authentifier
              </button>
            </form>
          </div>
        <% end %>
    
        <div class="fr-mb-3w">
          <form method="get" action="/clear">
            <button type="submit" class="fr-btn fr-btn--tertiary">
              üóëÔ∏è Effacer les Tokens
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="fr-card fr-mb-4w">
    <div class="fr-card__body">
      <div class="fr-card__content">
        <h2 class="fr-card__title">March√©s Publics Cr√©√©s</h2>
    
        <% if @markets&.any? %>
          <div class="fr-table">
            <table>
              <thead>
                <tr>
                  <th>Identifiant</th>
                  <th>Nom</th>
                  <th>Lot</th>
                  <th>Candidatures</th>
                  <th>Statut</th>
                  <th>Webhook</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @markets.each do |market| %>
                  <tr class="<%= market.status %> market-row" data-identifier="<%= market.identifier %>">
                    <td><code><%= market.identifier %></code></td>
                    <td><%= market.name %></td>
                    <td><%= market.lot_name || '-' %></td>
                    <td>
                      <span class="fr-badge">
                        <%= market.completed_applications_count %>/<%= market.applications_count %>
                      </span>
                    </td>
                    <td>
                      <span class="fr-badge fr-badge--<%= market.status == 'completed' ? 'success' : 'info' %>">
                        <%= market.status == 'completed' ? '‚úÖ Configur√©' : '‚è≥ En attente' %>
                      </span>
                    </td>
                    <td>
                      <% if market.has_webhook_data? %>
                        <small><%= market.webhook_received_at.strftime('%H:%M:%S') if market.webhook_received_at %></small>
                      <% else %>
                        <span class="fr-text--muted">-</span>
                      <% end %>
                    </td>
                    <td>
                      <% if market.status == 'completed' %>
                        <a href="/markets/<%= market.identifier %>" class="fr-btn fr-btn--sm">
                          Voir d√©tails ‚Üí
                        </a>
                      <% else %>
                        <a href="<%= ENV['FAST_TRACK_URL'] %>/buyer/public_markets/<%= market.identifier %>/setup" 
                           target="_blank" class="fr-btn fr-btn--sm fr-btn--primary" rel="noopener external">
                          Configurer
                        </a>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p class="fr-text--center fr-text--muted fr-p-4w">Aucun march√© cr√©√© pour le moment.</p>
        <% end %>
      </div>
    </div>
  </div>

  <div class="fr-card fr-mb-4w">
    <div class="fr-card__body">
      <div class="fr-card__content">
        <h2 class="fr-card__title">Instructions</h2>
        <ol>
          <li>Assurez-vous que <strong>Voie Rapide</strong> est lanc√© sur <code><%= ENV['FAST_TRACK_URL'] %></code></li>
          <li>Cliquez sur <strong>"S'authentifier"</strong> pour obtenir un token OAuth2</li>
          <li>Une fois authentifi√©, cr√©ez un march√© public avec le formulaire</li>
          <li>Cliquez sur l'URL de configuration pour configurer le march√©</li>
          <li>Compl√©tez la configuration - le march√© appara√Ætra comme "Termin√©" via webhook</li>
        </ol>
    
        <div class="fr-callout fr-callout--blue-france">
          <p class="fr-callout__title">üîó Webhook Endpoint</p>
          <p class="fr-callout__text">
            <code>POST /webhooks/voie-rapide</code><br>
            Pr√™t √† recevoir les notifications de completion de Voie Rapide
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
