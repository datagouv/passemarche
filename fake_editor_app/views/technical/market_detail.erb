<div class="fr-mb-4w">
  <nav role="navigation" class="fr-breadcrumb" aria-label="vous √™tes ici :">
    <button class="fr-breadcrumb__button" aria-expanded="false" aria-controls="breadcrumb-1">Voir le fil d'Ariane</button>
    <div class="fr-collapse" id="breadcrumb-1">
      <ol class="fr-breadcrumb__list">
        <li>
          <a class="fr-breadcrumb__link" href="/">Dashboard</a>
        </li>
        <li>
          <a class="fr-breadcrumb__link" aria-current="page">D√©tails du march√©</a>
        </li>
      </ol>
    </div>
  </nav>
  
  <h1>D√©tails du March√©</h1>
  
  <div class="fr-card fr-mb-4w">
    <div class="fr-card__body">
      <div class="fr-card__content">
        <h2 class="fr-card__title"><%= @market.name %></h2>
        <div class="fr-grid-row fr-grid-row--gutters">
          <div class="fr-col-12">
            <p><strong>Identifiant:</strong> <code><%= @market.identifier %></code></p>
            <p><strong>Lot:</strong> <%= @market.lot_name || 'N/A' %></p>
            <p><strong>Statut:</strong> 
              <span class="fr-badge fr-badge--<%= @market.status == 'completed' ? 'success' : 'info' %>">
                <%= @market.status == 'completed' ? '‚úÖ Configur√©' : '‚è≥ En attente' %>
              </span>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <% if @market.has_webhook_data? %>
    <div class="fr-card fr-card--grey fr-mb-4w" id="webhook">
      <div class="fr-card__body">
        <div class="fr-card__content">
          <h2 class="fr-card__title">üîç Debug Webhook Data</h2>
          <p><strong>Re√ßu le:</strong> <%= format_paris_time(@market.webhook_received_at) %></p>
          <div class="fr-callout">
            <h3 class="fr-callout__title">Contenu complet du webhook:</h3>
            <pre class="fr-text--xs"><%= JSON.pretty_generate(@market.webhook_data) %></pre>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  
  <div class="fr-card fr-mb-4w">
    <div class="fr-card__body">
      <div class="fr-card__content">
        <h2 class="fr-card__title">Candidatures (<%= @applications.count %>)</h2>
        
        <% if @current_token&.valid? && @market.status == 'completed' %>
          <div class="fr-callout fr-callout--green-tilleul-verveine fr-mb-3w">
            <h3 class="fr-callout__title">Cr√©er une candidature test</h3>
            <form action="/start_application" method="post" class="fr-form">
              <input type="hidden" name="market_identifier" value="<%= @market.identifier %>">
              <div class="fr-input-group">
                <label class="fr-label" for="siret">SIRET (optionnel)</label>
                <input class="fr-input" type="text" id="siret" name="siret" placeholder="SIRET (optionnel)" maxlength="14">
                <span class="fr-hint-text">
                  <strong>SIRET de test disponibles :</strong><br>
                  ‚Ä¢ <code>30613890001294</code> - Administration publique ‚úì<br>
                  ‚Ä¢ <code>77567227221138</code> - Croix Rouge Fran√ßaise (Association) ‚úì<br>
                  ‚Ä¢ <code>42417936400023</code> - Association locale Alsace-Moselle ‚úì<br>
                  ‚Ä¢ <code>00000000000000</code> - Erreur 404 (entit√© non trouv√©e) ‚úó
                </span>
                <span> Si un autre siret est fourni en param√®tres, alors l'api renverra les donn√©es associ√©es au siret 30613890001294</span>
              </div>
              <button type="submit" class="fr-btn fr-btn--primary">
                D√©marrer une candidature test
              </button>
            </form>
          </div>
        <% end %>
    
        <% if @applications.any? %>
          <div class="fr-table">
            <table>
              <thead>
                <tr>
                  <th>Identifiant</th>
                  <th>SIRET</th>
                  <th>Statut</th>
                  <th>Date de cr√©ation</th>
                  <th>Date de compl√©tion</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @applications.each do |app| %>
                  <tr class="<%= app.status %>">
                    <td><code><%= app.identifier %></code></td>
                    <td><%= app.siret || 'Non renseign√©' %></td>
                    <td>
                      <span class="fr-badge fr-badge--<%= app.status == 'completed' ? 'success' : 'info' %>">
                        <% if app.status == 'completed' %>
                          ‚úÖ Termin√©e
                        <% else %>
                          ‚è≥ En cours
                        <% end %>
                      </span>
                    </td>
                    <td><%= format_paris_time(app.created_at, '%d/%m/%Y %H:%M') %></td>
                    <td><%= format_paris_time(app.completed_at, '%d/%m/%Y %H:%M') %></td>
                    <td>
                      <a href="/applications/<%= app.identifier %>" class="fr-btn fr-btn--sm">
                        D√©tails
                      </a>
                      <% if app.status != 'completed' %>
                        <a href="<%= ENV['FAST_TRACK_URL'] %>/candidate/market_applications/<%= app.identifier %>/company_identification" 
                           target="_blank" class="fr-btn fr-btn--sm fr-btn--secondary" rel="noopener external">
                          Reprendre
                        </a>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p class="fr-text--center fr-text--muted fr-p-4w">Aucune candidature pour ce march√©.</p>
        <% end %>
      </div>
    </div>
  </div>
</div>
