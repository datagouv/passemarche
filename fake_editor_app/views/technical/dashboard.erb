<div class="fr-container fr-py-6w">
  <div class="fr-mb-4w">
    <nav role="navigation" class="fr-breadcrumb" aria-label="vous Ãªtes ici :">
      <button class="fr-breadcrumb__button" aria-expanded="false" aria-controls="breadcrumb-technical">Voir le fil d'Ariane</button>
      <div class="fr-collapse" id="breadcrumb-technical">
        <ol class="fr-breadcrumb__list">
          <li>
            <a class="fr-breadcrumb__link" href="/">ğŸ  Accueil</a>
          </li>
          <li>
            <a class="fr-breadcrumb__link" aria-current="page">âš™ï¸ Tableau de bord Technique</a>
          </li>
        </ol>
      </div>
    </nav>

    <h1>
      âš™ï¸ Tableau de bord Technique â­
    </h1>
    <p class="fr-text--lead">ğŸ”§ L'atelier du PÃ¨re NoÃ«l - Gestion de l'authentification OAuth et donnÃ©es techniques</p>
  </div>

  <!-- ğŸ¬ CANDY CANE DIVIDER ğŸ¬ -->
  <div class="candy-cane-divider"></div>

  <% if @error %>
    <div class="fr-alert fr-alert--error fr-mb-4w">
      <h3 class="fr-alert__title">âŒ Erreur</h3>
      <p><%= @error %></p>
    </div>
  <% end %>

  <!-- Tabs Navigation -->
  <div class="fr-tabs">
    <ul class="fr-tabs__list" role="tablist" aria-label="Navigation par onglets">
      <li role="presentation">
        <button class="fr-tabs__tab <%= 'fr-tabs__tab--selected' if @tab == 'auth' || !@tab %>"
                id="tab-button-auth"
                role="tab"
                aria-selected="<%= (@tab == 'auth' || !@tab) ? 'true' : 'false' %>"
                aria-controls="tab-auth">
          ğŸ” Authentification
        </button>
      </li>
      <li role="presentation">
        <button class="fr-tabs__tab <%= 'fr-tabs__tab--selected' if @tab == 'config' %>"
                id="tab-button-config"
                role="tab"
                aria-selected="<%= @tab == 'config' ? 'true' : 'false' %>"
                aria-controls="tab-config">
          âš™ï¸ Configuration
        </button>
      </li>
    </ul>

    <!-- Tab Content: Authentication -->
    <div class="fr-tabs__panel <%= 'fr-tabs__panel--selected' if @tab == 'auth' || !@tab %>" id="tab-auth" role="tabpanel" tabindex="0">
      <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-12 fr-col-lg-8">
          <div class="fr-card <%= @current_token&.valid? ? 'fr-card--green-emeraude' : 'fr-card--orange-terre-battue' %>">
            <div class="fr-card__body">
              <div class="fr-card__content">
                <h2 class="fr-mb-3w">
                  <% if @current_token&.valid? %>
                    ğŸ… AuthentifiÃ© auprÃ¨s de Passe MarchÃ© - Vous Ãªtes sur la liste des gentils !
                  <% else %>
                    ğŸ”“ Non authentifiÃ© - Le PÃ¨re NoÃ«l attend votre connexion !
                  <% end %>
                </h2>

                <% if @current_token&.valid? %>
                  <div class="fr-table fr-table--layout-fixed">
                    <table>
                      <caption class="sr-only">DÃ©tails du token OAuth</caption>
                      <thead>
                        <tr>
                          <th scope="col">ğŸ·ï¸ PropriÃ©tÃ©</th>
                          <th scope="col">ğŸ“¦ Valeur</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <th scope="row">ğŸ”‘ Access Token</th>
                          <td>
                            <code><%= @current_token.access_token[0..20] %>...</code>
                          </td>
                        </tr>
                        <tr>
                          <th scope="row">ğŸ“‹ Token Type</th>
                          <td><%= @current_token.token_type %></td>
                        </tr>
                        <tr>
                          <th scope="row">ğŸ¯ Scope</th>
                          <td><%= @current_token.scope || 'N/A' %></td>
                        </tr>
                        <tr>
                          <th scope="row">ğŸ“… CrÃ©Ã© le</th>
                          <td><%= format_paris_time(@current_token.created_at) %></td>
                        </tr>
                        <tr>
                          <th scope="row">â° Expire le</th>
                          <td><%= format_paris_time(@current_token.expires_at) %></td>
                        </tr>
                        <tr>
                          <th scope="row">â³ Temps restant</th>
                          <td>
                            <span class="fr-badge fr-badge--success">
                              ğŸ„ <%= @current_token.time_until_expiry / 60 %> minutes
                            </span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <div class="fr-btns-group fr-btns-group--inline fr-mt-3w">
                    <form action="/refresh" method="post" style="display: inline;">
                      <input type="hidden" name="redirect_back" value="/technical">
                      <button type="submit" class="fr-btn fr-btn--secondary">
                        ğŸ”„ RafraÃ®chir le token
                      </button>
                    </form>
                    <form action="/clear" method="get" style="display: inline;">
                      <input type="hidden" name="redirect_back" value="/technical">
                      <button type="submit" class="fr-btn fr-btn--tertiary-no-outline">
                        ğŸ—‘ï¸ Supprimer le token
                      </button>
                    </form>
                  </div>
                <% else %>
                  <p class="fr-mb-3w">
                    ğŸ… Vous devez vous authentifier auprÃ¨s de Passe MarchÃ© pour utiliser les fonctionnalitÃ©s de crÃ©ation de marchÃ©s et de candidatures.
                    <br><br>
                    <span style="font-style: italic; color: #228b22;">Le PÃ¨re NoÃ«l ne partage ses cadeaux qu'avec les utilisateurs authentifiÃ©s !</span>
                  </p>

                  <form action="/authenticate" method="post">
                    <input type="hidden" name="redirect_back" value="/technical">
                    <button type="submit" class="fr-btn fr-btn--primary fr-btn--lg">
                      ğŸ” S'authentifier via OAuth2
                    </button>
                  </form>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar Info -->
        <div class="fr-col-12 fr-col-lg-4">
          <div class="fr-callout fr-callout--blue-ecume fr-mb-3w">
            <h3 class="fr-callout__title">
              ğŸ… Flow OAuth2
            </h3>
            <p class="fr-callout__text fr-text--sm">
              Cette application utilise le flow <strong>Client Credentials</strong> pour s'authentifier auprÃ¨s de Passe MarchÃ©.<br><br>
              ğŸ Le token d'accÃ¨s est automatiquement gÃ©rÃ© et peut Ãªtre rafraÃ®chi manuellement si nÃ©cessaire.
            </p>
          </div>

          <div class="fr-callout christmas-card-technical">
            <h3 class="fr-callout__title">
              ğŸ“Š Statistiques de NoÃ«l
            </h3>
            <p class="fr-text--sm">
              <strong>ğŸ <%= Market.count %></strong> marchÃ©<%= 's' if Market.count > 1 %> sous le sapin<br>
              <strong>ğŸ“‹ <%= MarketApplication.count %></strong> candidature<%= 's' if MarketApplication.count > 1 %> dÃ©posÃ©es
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Content: Configuration -->
    <div class="fr-tabs__panel <%= 'fr-tabs__panel--selected' if @tab == 'config' %>" id="tab-config" role="tabpanel" tabindex="0">
      <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-12 fr-col-lg-8">
          <div class="fr-card christmas-card-technical">
            <div class="fr-card__body">
              <div class="fr-card__content">
                <h2 class="fr-mb-3w">âš™ï¸ Configuration OAuth2 - L'atelier du PÃ¨re NoÃ«l</h2>
                <div class="fr-table fr-table--layout-fixed">
                  <table>
                    <caption class="sr-only">Configuration OAuth2</caption>
                    <thead>
                      <tr>
                        <th scope="col">ğŸ·ï¸ PropriÃ©tÃ©</th>
                        <th scope="col">ğŸ“¦ Valeur</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <th scope="row">ğŸ”‘ Client ID</th>
                        <td><code><%= ENV.fetch('CLIENT_ID', 'Non configurÃ©')[0..15] %>...</code></td>
                      </tr>
                      <tr>
                        <th scope="row">ğŸŒ URL Passe MarchÃ©</th>
                        <td><code style="word-break: break-all;"><%= ENV.fetch('FAST_TRACK_URL', 'Non configurÃ©') %></code></td>
                      </tr>
                      <tr>
                        <th scope="row">ğŸ”„ Flow OAuth</th>
                        <td>Client Credentials</td>
                      </tr>
                      <tr>
                        <th scope="row">ğŸ¤« Client Secret</th>
                        <td><code><%= ENV.fetch('CLIENT_SECRET', 'Non configurÃ©') ? '***' : 'Non configurÃ©' %></code></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar Info -->
        <div class="fr-col-12 fr-col-lg-4">
          <div class="fr-callout fr-callout--blue-ecume">
            <h3 class="fr-callout__title">
              ğŸ“– Documentation
            </h3>
            <div class="fr-btns-group fr-btns-group--icon-left">
              <a href="<%= ENV['FAST_TRACK_URL'] %>" target="_blank" rel="noopener external" class="fr-btn fr-btn--sm fr-btn--tertiary-no-outline">
                ğŸ Passe MarchÃ©
              </a>
            </div>
          </div>

          <div class="fr-notice fr-notice--info fr-mt-3w">
            <div class="fr-notice__body">
              <p class="fr-notice__title">ğŸ… Ã€ propos de cette page</p>
              <p class="fr-text--sm">
                Cette page technique permet de gÃ©rer l'authentification OAuth2 et de consulter les donnÃ©es brutes.
                Utilisez les interfaces Acheteur ou Candidat pour les scÃ©narios utilisateur.
                <br><br>
                <span style="font-style: italic;">ğŸ„ L'atelier secret du PÃ¨re NoÃ«l pour les dÃ©veloppeurs !</span>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Christmas message -->
  <div style="text-align: center; margin-top: 2rem; padding: 1rem; background: rgba(255,215,0,0.1); border-radius: 8px;">
    <span style="font-size: 2rem;">âš™ï¸â­ğŸ”§</span>
    <p style="color: #b8860b; font-weight: bold; margin: 0.5rem 0;">L'atelier technique vous souhaite de Joyeuses FÃªtes !</p>
  </div>
</div>
