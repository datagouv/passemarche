<% content_for :title, "#{@market_application.siret} - #{t('candidate.market_applications.steps.market_and_company_information')}" %>

<%= stepper(
  current_step: step,
  steps: @wizard_steps,
  i18n_scope: 'candidate',
  show_separator: true
) %>

<% subcategories = ['market_information'] + @presenter.subcategories_for_category(step.to_s) %>

<%= form_with model: @market_application, url: wizard_path, local: true, data: { turbo: false }, class: "fr-mb-4w" do |form| %>
  <div class="fr-grid-row">
    <% if subcategories.any? %>
      <%= render "sidemenu_subcategories", subcategories: %>
    <% end %>
    
    <div class="<%= subcategories.any? ? 'fr-col-9' : 'fr-col-12' %>">
      <% if subcategories.any? %>
        <% step_responses = @market_application.market_attribute_responses
             .joins(:market_attribute)
             .where(market_attributes: { category_key: step.to_s })
             .includes(:market_attribute)
             .order('market_attributes.id') %>

        <% responses_by_subcategory = step_responses.group_by { |r| r.market_attribute.subcategory_key } %>
        
        <% subcategories.each do |subcategory| %>
          <div class="fr-mb-4w">
            <h6 id="<%= subcategory %>" class="fr-text-title--blue-france fr-mb-2w">
              <%= t("form_fields.candidate.subcategories.#{subcategory}", 
                    default: t("candidate.market_applications.manual_subcategories.#{subcategory}", 
                              default: subcategory.humanize)) %>
            </h6>
            
            <% if subcategory == 'market_information' %>
              <ul class="fr-list fr-mb-3w">
                <li class="fr-list__item">
                  <div class="field-layout-container">
                    <div class="field-layout-content">
                      <strong>Nom du marché</strong>
                      <br>
                      <span class="fr-text--sm fr-text--mention-grey"><%= @market_application.public_market.name %></span>
                    </div>
                  </div>
                </li>
                <% if @market_application.public_market.lot_name.present? %>
                  <li class="fr-list__item">
                    <div class="field-layout-container">
                      <div class="field-layout-content">
                        <strong>Nom du lot</strong>
                        <br>
                        <span class="fr-text--sm fr-text--mention-grey"><%= @market_application.public_market.lot_name %></span>
                      </div>
                    </div>
                  </li>
                <% end %>
                <li class="fr-list__item">
                  <div class="field-layout-container">
                    <div class="field-layout-content">
                      <strong>Date et heure limite de remise des plis</strong>
                      <br>
                      <span class="fr-text--sm fr-text--mention-grey"><%= l(@market_application.public_market.deadline, format: '%d/%m/%Y %H:%M') %> (heure de Paris)</span>
                    </div>
                  </div>
                </li>
                <li class="fr-list__item">
                  <div class="field-layout-container">
                    <div class="field-layout-content">
                      <strong>Typologie de marché</strong>
                      <br>
                      <span class="fr-text--sm fr-text--mention-grey">
                        <% if @market_application.public_market.market_type_codes.any? %>
                          <% @market_application.public_market.market_type_codes.each do |market_type_code| %>
                            <span class="fr-badge fr-badge--sm fr-mr-1w">
                              <%= t("market_types.#{market_type_code}", default: market_type_code.humanize) %>
                            </span>
                          <% end %>
                        <% else %>
                          Aucun type de marché défini
                        <% end %>
                      </span>
                    </div>
                  </div>
                </li>
              </ul>
            <% else %>
              <% subcategory_responses = responses_by_subcategory[subcategory] || [] %>
              <% if subcategory_responses.any? %>
                <div class="fr-fieldset">
                <% subcategory_responses.each do |response| %>
                  <div class="fr-fieldset__element">
                    <%= render "candidate/market_applications/market_attribute_responses/#{response.type.underscore}_form", 
                           market_attribute_response: response, form: form %>
                  </div>
                <% end %>
              </div>
              <% else %>
                <p class="fr-text--sm fr-text--mention-grey">Aucun champ configuré pour cette sous-catégorie.</p>
              <% end %>
            <% end %>
          </div>
        <% end %>
      <% else %>
        <p class="fr-text--sm fr-text--mention-grey">Aucun contenu disponible pour cette étape.</p>
      <% end %>
    </div>
  </div>

  <%= render "wizard_nav" %>
<% end %>
