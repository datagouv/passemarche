<% content_for :title, t('candidate.market_applications.steps.api_data_recovery_status') %>

<%
  # Check if all APIs are done (completed or failed)
  all_done = @market_application.api_fetch_status.values.all? { |status| ['completed', 'failed'].include?(status['status']) }
%>

<div class="fr-grid-row full-height-grid"
     data-controller="sync-status"
     data-sync-status-url-value="<%= step_candidate_market_application_path(@market_application.identifier, :api_data_recovery_status, format: :json) %>">
  <div class="fr-col-12 fr-col-lg-7">
    <div class="fr-container--fluid">
      <div class="fr-grid-row">
        <div class="fr-mb-5w fr-pt-4w">
          <h1 class="fr-h1 fr-mb-1w"><%= t('candidate.market_applications.api_data_recovery_status.title') %></h1>
          <p class="fr-text--lg fr-mb-0">
            <%= t('candidate.market_applications.api_data_recovery_status.description') %>
          </p>
        </div>
      </div>

      <div class="fr-grid-row">
        <div class="fr-mb-4w">
          <h2 class="fr-h4"><%= t('candidate.market_applications.api_data_recovery_status.apis_list_title') %></h2>
          <ul class="fr-mb-4w">
            <% @market_application.public_market.market_attributes.from_api.pluck(:api_name).uniq.each do |api_name| %>
              <% status_data = @market_application.api_fetch_status[api_name] || {} %>
              <% status = status_data['status'] || 'pending' %>
              <li class="fr-text--lg">
                <%= api_name %> -
                <% if status == 'completed' %>
                  <span class="fr-badge fr-badge--success">Récupéré</span>
                <% elsif status == 'failed' %>
                  <span class="fr-badge fr-badge--error">Échec</span>
                <% elsif status == 'processing' %>
                  <span class="fr-badge fr-badge--info">En cours...</span>
                <% else %>
                  <span class="fr-badge">En attente...</span>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>

      <%= form_with model: @market_application, url: wizard_path, method: :put, local: true, data: { turbo: false } do |form| %>
        <div class="fr-btns-group fr-btns-group--inline">
          <%= link_to previous_wizard_path, class: "fr-btn fr-btn--secondary" do %>
            <span class="fr-icon-arrow-left-line" aria-hidden="true"></span>
            <span class="fr-ml-1w">Précédent</span>
          <% end %>
          <%= form.submit t('button.continue'), class: "fr-btn", disabled: !all_done, data: { sync_status_target: "continueButton", initial_state: all_done ? "enabled" : "disabled" } %>
        </div>
      <% end %>

      <% unless all_done %>
        <p class="fr-text--sm fr-mt-2w">
          <em>Veuillez patienter pendant la récupération de vos données...</em>
        </p>
      <% end %>
    </div>
  </div>

  <div class="fr-col-12 fr-col-lg-1"></div>

  <div class="fr-col-12 fr-col-lg-4 fr-background-alt--blue-france">
    <div class="center-content">
      <% if all_done %>
        <%= image_tag "form-logo.png", alt: "Logo de formulaire" %>
      <% else %>
        <div class="sync-loader"
             role="img"
             aria-label="Récupération des données en cours..."
             data-sync-status-target="loader">
        </div>
      <% end %>
    </div>
  </div>
</div>
