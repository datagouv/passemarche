<% content_for :title, t('candidate.market_applications.steps.api_data_recovery_status') %>

<div class="fr-container fr-py-6w"
     data-controller="sync-status"
     data-sync-status-url-value="<%= step_candidate_market_application_path(@market_application.identifier, :api_data_recovery_status, format: :json) %>">
  <div class="fr-grid-row fr-grid-row--gutters">
    <div class="fr-col-12 fr-col-md-6">
      <div class="fr-callout">
        <h1 class="fr-callout__title">
          <%= t('candidate.market_applications.api_data_recovery_status.title') %>
        </h1>
        <p class="fr-callout__text">
          <%= t('candidate.market_applications.api_data_recovery_status.description') %>
        </p>
        <p class="fr-callout__text">
          <%= @api_block_status_presenter.overall_status_message %>
        </p>
      </div>

      <%= form_with model: @market_application, url: wizard_path, method: :put, local: true, data: { turbo: false } do |form| %>
        <div class="fr-btns-group fr-btns-group--inline fr-mt-4w">
          <%= link_to previous_wizard_path, class: "fr-btn fr-btn--secondary" do %>
            <span class="fr-icon-arrow-left-line" aria-hidden="true"></span>
            <span class="fr-ml-1w">Précédent</span>
          <% end %>
          <%= form.submit t('button.continue'),
                          class: "fr-btn",
                          disabled: !@api_block_status_presenter.all_blocks_done?,
                          data: {
                            sync_status_target: "continueButton",
                            initial_state: @api_block_status_presenter.all_blocks_done? ? "enabled" : "disabled"
                          } %>
        </div>
      <% end %>
    </div>

    <div class="fr-col-12 fr-col-md-6">
      <h2 class="fr-h5 fr-mb-3w">
        <%= t('candidate.market_applications.api_data_recovery_status.blocks_list_title') %>
      </h2>

      <ul class="fr-list fr-list--unstyled">
        <% @api_block_status_presenter.blocks.each do |block| %>
          <li class="fr-mb-3w" data-block-name="<%= block.name %>">
            <div class="fr-card fr-card--sm">
              <div class="fr-card__body">
                <div class="fr-card__content">
                  <div class="fr-grid-row fr-grid-row--middle">
                    <div class="fr-col-2 fr-text-center">
                      <span class="fr-icon-<%= block.icon %> fr-icon--lg"
                            aria-hidden="true"></span>
                    </div>
                    <div class="fr-col-8">
                      <h3 class="fr-card__title fr-mb-1v">
                        <%= block.name %>
                      </h3>
                      <p class="fr-card__desc fr-text--xs fr-mb-0">
                        <%= block.description %>
                      </p>
                    </div>
                    <div class="fr-col-2 fr-text-center">
                      <% if block.loading? %>
                        <span class="fr-icon-refresh-line fr-icon--lg"
                              aria-hidden="true"></span>
                      <% elsif block.completed? %>
                        <span class="fr-icon-checkbox-circle-line fr-icon--lg"
                              style="color: var(--success-425-625);"
                              aria-hidden="true"></span>
                      <% elsif block.failed? %>
                        <span class="fr-icon-close-circle-line fr-icon--lg"
                              style="color: var(--error-425-625);"
                              aria-hidden="true"></span>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </li>
        <% end %>
      </ul>
    </div>
  </div>
</div>
