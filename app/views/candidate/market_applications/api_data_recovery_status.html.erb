<% content_for :title, t('candidate.market_applications.steps.api_data_recovery_status') %>

<div class="fr-container fr-py-6w"
     data-controller="sync-status"
     data-sync-status-url-value="<%= step_candidate_market_application_path(@market_application.identifier, :api_data_recovery_status, format: :json) %>">
  <div class="fr-grid-row fr-grid-row--gutters">
    <div class="fr-col-12 fr-col-md-6 fr-px-5w fr-py-8w">
      <h1 class="fr-h4 fr-mb-3w" style="color: var(--blue-france-sun-113-625);">
        <%= t('candidate.market_applications.api_data_recovery_status.title') %>
      </h1>

      <p class="fr-text--lg fr-mb-3w">
        <%= t('candidate.market_applications.api_data_recovery_status.description') %>
      </p>

      <div class="fr-mb-4w">
        <p class="fr-text--lg fr-p-3w fr-mb-2w fr-background-alt--blue-france fr-text-title--blue-france" style="display: flex; align-items: center; gap: 0.75rem;">
          <%= image_tag "icon-warning-triangle.svg", width: 32, height: 32, aria: { hidden: true }, style: "flex-shrink: 0;" %>
          <span><%= t('candidate.market_applications.api_data_recovery_status.benefit_info') %></span>
        </p>
        <p class="fr-text--lg fr-p-3w fr-mb-2w fr-background-alt--grey" style="display: flex; align-items: center; gap: 0.75rem;">
          <%= image_tag "icon-info.svg", width: 32, height: 32, aria: { hidden: true }, style: "flex-shrink: 0;" %>
          <span><%= t('candidate.market_applications.api_data_recovery_status.benefit_locked') %></span>
        </p>
        <p class="fr-text--lg fr-p-3w fr-mb-0 fr-background-alt--grey" style="display: flex; align-items: center; gap: 0.75rem;">
          <%= image_tag "icon-target.svg", width: 30, height: 30, aria: { hidden: true }, style: "flex-shrink: 0;" %>
          <span><%= t('candidate.market_applications.api_data_recovery_status.benefit_accuracy') %></span>
        </p>
      </div>

      <%= form_with model: @market_application, url: wizard_path, method: :put, local: true, data: { turbo: false } do |form| %>
        <div class="fr-btns-group fr-btns-group--inline fr-mt-4w">
          <%= link_to previous_wizard_path, class: "fr-btn fr-btn--secondary" do %>
            <span class="fr-icon-arrow-left-line" aria-hidden="true"></span>
            <span class="fr-ml-1w">Précédent</span>
          <% end %>
          <%= form.submit t('button.continue'),
                          class: "fr-btn",
                          disabled: !@api_block_status_presenter.all_blocks_done?,
                          data: {
                            sync_status_target: "continueButton",
                            initial_state: @api_block_status_presenter.all_blocks_done? ? "enabled" : "disabled"
                          } %>
        </div>
      <% end %>
    </div>

    <div class="fr-col-12 fr-col-md-6 fr-background-alt--blue-france fr-px-5w fr-py-8w">
      <h2 class="fr-h5 fr-mb-3w">
        <%= t('candidate.market_applications.api_data_recovery_status.blocks_list_title') %>
      </h2>

      <ul class="fr-list fr-list--unstyled" style="list-style-type: none; padding-left: 0;">
        <% @api_block_status_presenter.blocks.each do |block| %>
          <li class="fr-mb-3w" data-block-name="<%= block.name %>">
            <div class="fr-card fr-card--sm">
              <div class="fr-card__body">
                <div class="fr-card__content">
                  <div class="fr-grid-row fr-grid-row--middle">
                    <div class="fr-col-10">
                      <h3 class="fr-card__title fr-mb-1v" style="color: var(--blue-france-sun-113-625);">
                        <%= block.name %>
                      </h3>
                      <p class="fr-card__desc fr-text--xs fr-mb-0">
                        <%= block.description %>
                      </p>
                    </div>
                    <div class="fr-col-2" style="display: flex; justify-content: flex-end; align-items: center;">
                      <% if block.loading? %>
                        <div class="sync-loader sync-loader--sm"
                             role="img"
                             aria-label="Chargement en cours..."></div>
                      <% elsif block.completed? %>
                        <%= image_tag "icon-api-success.svg", width: 40, height: 40, aria: { hidden: true } %>
                      <% elsif block.failed? %>
                        <%= image_tag "icon-api-error.svg", width: 40, height: 40, aria: { hidden: true } %>
                      <% end %>
                    </div>
                  </div>

                  <div class="fr-mt-2w">
                    <% if block.done? %>
                      <p class="fr-mb-0 api-status-summary">
                        <span class="api-status-count <%= block.status_count_class %>">
                          <%= block.completed_count %>/<%= block.total_count %>:
                        </span>
                        <%= block.done_message %>
                      </p>
                    <% else %>
                      <div class="api-status-segments">
                        <% block.api_statuses.each do |api_status| %>
                          <div class="api-status-segment"
                               style="background-color: <%= api_status[:color] %>;"
                               title="<%= api_status[:name] %>: <%= api_status[:status] %>"></div>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          </li>
        <% end %>
      </ul>
    </div>
  </div>
</div>
