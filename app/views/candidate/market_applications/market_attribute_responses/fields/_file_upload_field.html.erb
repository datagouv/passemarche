<%# Expected variables: form:, attribute_response: %>
<%
  documents = attribute_response.documents
  market_application_identifier = attribute_response.market_application&.identifier
%>

<div class="fr-upload-group fr-card fr-p-2w"
     data-controller="direct-upload"
     data-direct-upload-market-application-identifier-value="<%= market_application_identifier %>"
     data-direct-upload-deletable-value="true">
  <%= form.label :files, "Ajouter vos documents", class: "fr-label fr-mb-2w fr-text--md", for: "upload-#{attribute_response.id}" %>
  <span class="fr-hint-text fr-mb-2w fr-text--sm">
    Taille maximale : <%= MarketAttributeResponse::FileUpload::MAX_FILE_SIZE / 1.megabyte %> Mo.
    Formats support√©s : jpg, png, pdf. Plusieurs fichiers possibles.
  </span>
  <%= form.file_field :files,
      class: "fr-upload",
      multiple: true,
      direct_upload: true,
      accept: ".pdf,.doc,.docx,.jpg,.jpeg,.png",
      id: "upload-#{attribute_response.id}",
      aria: { describedby: "upload-#{attribute_response.id}-messages" } %>

  <div data-direct-upload-target="progress" class="hidden fr-mt-1w">
    <div class="direct-upload-progress">
      <div data-direct-upload-target="progressBar" class="direct-upload-progress-bar"></div>
    </div>
  </div>

  <div data-direct-upload-target="filesList" class="files-list">
    <% if documents.attached? %>
      <div class="fr-mt-2w fr-text--sm fr-mb-0">
        <strong>Fichiers actuels :</strong>
        <% documents.each do |document| %>
          <%# Add hidden field to preserve file on form resubmit (backend handles duplicates) %>
          <%= form.hidden_field(:files, multiple: true, value: document.signed_id, id: nil) %>
          <div class="file-item" data-signed-id="<%= document.signed_id %>">
            <%= link_to document.filename.to_s, url_for(document), target: "_blank", rel: "noopener", class: "file-link" %>
            <span class="file-delete-wrapper">
              <button type="button"
                      class="fr-btn fr-btn--tertiary-no-outline fr-btn--sm fr-icon-delete-line"
                      data-controller="file-delete"
                      data-file-delete-signed-id-value="<%= document.signed_id %>"
                      data-file-delete-url-value="<%= delete_attachment_candidate_market_application_path(market_application_identifier, document.signed_id) %>"
                      data-file-delete-filename-value="<%= document.filename %>"
                      data-action="click->file-delete#delete"
                      title="Supprimer <%= document.filename %>">
                Supprimer
              </button>
            </span>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if form.object.errors[:base].present? %>
    <p class="fr-error-text">
      <%= form.object.errors[:base].first %>
    </p>
  <% end %>
</div>
