<%
  value_data = market_attribute_response.value || {}
  key = market_attribute_response.market_attribute.key
%>

<% if market_attribute_response.auto? %>
  <%# Data filled automatically from API - show indicator but not the value %>
  <%= form.fields_for :market_attribute_responses, market_attribute_response,
                      child_index: market_attribute_response.id do |response_form| %>
    <%= response_form.hidden_field :id %>
    <%= response_form.hidden_field :market_attribute_id %>
    <%= response_form.hidden_field :type %>
  <% end %>

  <div class="fr-mb-2w">
    <label class="fr-label">
      <%= t("form_fields.candidate.fields.#{key}.name", default: key.humanize) %>
      <%= render 'candidate/market_applications/market_attribute_responses/source_badge', market_attribute_response: market_attribute_response %>
    </label>
    <p class="fr-text--sm fr-text--mention-grey">
      <%= t('candidate.market_applications.auto_filled_message') %>
    </p>
  </div>
<% else %>
  <%# Manual input or manual after API failure - show normal form %>
<div class="fr-input-group<%= ' fr-input-group--error' if market_attribute_response.errors[:value].any? %>">
  <%= form.fields_for :market_attribute_responses, market_attribute_response do |response_form| %>
    <%= response_form.hidden_field :id %>
    <%= response_form.hidden_field :market_attribute_id %>
    <%= response_form.hidden_field :type %>

    <h6 class="fr-mb-2w fr-text--md">
      <%= t("form_fields.candidate.fields.#{key}.name", default: key.humanize) %>
    </h6>

    <% if t("form_fields.candidate.fields.#{key}.description", default: nil).present? %>
      <div class="fr-hint-text fr-mb-3w fr-text--sm">
        <%= t("form_fields.candidate.fields.#{key}.description") %>
      </div>
    <% end %>

    <!-- 3x3 Grid Table -->
    <div class="fr-table">
      <div class="fr-table__wrapper">
        <div class="fr-table__container">
          <div class="fr-table__content">
            <table>
              <thead>
                <tr>
                  <th scope="col"><%= t('candidate.market_applications.form_fields.capacite_economique_financiere_chiffre_affaires_global_annuel.table_headers.year') %></th>
                  <th scope="col"><%= t('candidate.market_applications.form_fields.capacite_economique_financiere_chiffre_affaires_global_annuel.table_headers.turnover') %></th>
                  <th scope="col"><%= t('candidate.market_applications.form_fields.capacite_economique_financiere_chiffre_affaires_global_annuel.table_headers.market_percentage') %></th>
                  <th scope="col"><%= t('candidate.market_applications.form_fields.capacite_economique_financiere_chiffre_affaires_global_annuel.table_headers.fiscal_year_end') %></th>
                </tr>
              </thead>
              <tbody>
                <% %w[year_1 year_2 year_3].each_with_index do |year_key, index| %>
                  <tr>
                    <td>
                      <strong><%= t("candidate.market_applications.form_fields.capacite_economique_financiere_chiffre_affaires_global_annuel.year_labels.#{year_key}", default: "AnnÃ©e #{index + 1}") %></strong>
                    </td>
                    <td>
                      <div class="fr-input-group">
                        <%= response_form.text_field "#{year_key}_turnover",
                              type: "number",
                              class: "fr-input fr-input--sm",
                              placeholder: "ex: 500000",
                              step: 1,
                              min: 0,
                              required: true %>
                      </div>
                    </td>
                    <td>
                      <div class="fr-input-group">
                        <%= response_form.text_field "#{year_key}_market_percentage",
                              type: "number",
                              class: "fr-input fr-input--sm",
                              placeholder: "ex: 75",
                              step: 1,
                              min: 0,
                              max: 100,
                              required: true %>
                      </div>
                    </td>
                    <td>
                      <div class="fr-input-group">
                        <%= response_form.text_field "#{year_key}_fiscal_year_end",
                              type: "date",
                              class: "fr-input fr-input--sm",
                              required: true %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <% if market_attribute_response.errors[:value].any? %>
      <div class="fr-messages-group fr-mt-2w" aria-live="polite">
        <% market_attribute_response.errors[:value].each do |error_message| %>
          <p class="fr-message fr-message--error">
            <%= error_message %>
          </p>
        <% end %>
      </div>
    <% end %>

    <!-- Additional error handling for individual fields -->
    <% %w[year_1 year_2 year_3].each do |year_key| %>
      <% if market_attribute_response.errors[year_key.to_sym].any? %>
        <div class="fr-messages-group fr-mt-1w" aria-live="polite">
          <p class="fr-message fr-message--error">
            <%= t("candidate.market_applications.form_fields.capacite_economique_financiere_chiffre_affaires_global_annuel.year_labels.#{year_key}", default: year_key.humanize) %> :
            <%= market_attribute_response.errors[year_key.to_sym].first %>
          </p>
        </div>
      <% end %>
    <% end %>
  <% end %>
</div>
<% end %>
