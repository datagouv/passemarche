<%
  value_data = market_attribute_response&.value || {}
  key = market_attribute_response&.market_attribute&.key
  is_auto = market_attribute_response&.auto?
  has_errors = market_attribute_response&.errors&.[](:value)&.any?
%>

<div class="fr-input-group<%= ' fr-input-group--error' if has_errors %>">
  <%= form.fields_for :market_attribute_responses, market_attribute_response do |response_form| %>

    <%= response_form.hidden_field :id %>
    <%= response_form.hidden_field :market_attribute_id %>
    <%= response_form.hidden_field :type %>

    <h6 class="fr-mb-2w fr-text--md">
      <%= t("form_fields.candidate.fields.#{key}.name", default: key.humanize) %>
    </h6>

    <% if t("form_fields.candidate.fields.#{key}.description", default: nil).present? %>
      <div class="fr-hint-text fr-mb-2w fr-text--sm">
        <%= t("form_fields.candidate.fields.#{key}.description") %>
      </div>
    <% end %>

    <%# --- INFO NOTICE FOR AUTO-RETRIEVED DATA --- %>
    <%
      has_api_data = false
      if is_auto && value_data['_api_fields'].present?
        %w[year_1 year_2 year_3].each do |year_key|
          year_api_fields = value_data['_api_fields'][year_key] || []
          if year_api_fields.any?
            has_api_data = true
            break
          end
        end
      end
    %>

    <% if has_api_data %>
      <div class="fr-notice fr-notice--info fr-mb-2w">
        <div class="fr-notice__body fr-px-2w fr-py-1w">
          <p class="fr-notice__title"></p>
          <p class="fr-notice__desc">
            <%= t('candidate.market_applications.form_fields.capacite_economique_financiere_chiffre_affaires_global_annuel.notice') %>
          </p>
        </div>
      </div>
    <% end %>
      <div class="fr-table">
        <div class="fr-table__wrapper">
          <div class="fr-table__container">
            <div class="fr-table__content">
              <table>
              <thead>
                <tr>
                  <th scope="col"><%= t('candidate.market_applications.form_fields.capacite_economique_financiere_chiffre_affaires_global_annuel.table_headers.year') %></th>
                  <th scope="col"><%= t('candidate.market_applications.form_fields.capacite_economique_financiere_chiffre_affaires_global_annuel.table_headers.turnover') %></th>
                  <th scope="col"><%= t('candidate.market_applications.form_fields.capacite_economique_financiere_chiffre_affaires_global_annuel.table_headers.market_percentage') %></th>
                  <th scope="col"><%= t('candidate.market_applications.form_fields.capacite_economique_financiere_chiffre_affaires_global_annuel.table_headers.fiscal_year_end') %></th>
                </tr>
              </thead>
              <tbody>
                <% %w[year_1 year_2 year_3].each_with_index do |year_key, index| %>
                  <%
                    api_fields = value_data['_api_fields'] || {}
                    year_api_fields = api_fields[year_key] || []
                    turnover_from_api = is_auto && year_api_fields.include?('turnover')
                    fiscal_year_end_from_api = is_auto && year_api_fields.include?('fiscal_year_end')
                    has_api_data_for_year = turnover_from_api || fiscal_year_end_from_api
                  %>
                  <tr>
                    <td>
                      <strong><%= t("candidate.market_applications.form_fields.capacite_economique_financiere_chiffre_affaires_global_annuel.year_labels.#{year_key}", default: "Année #{index + 1}") %></strong>
                    </td>

                    <%# --- TURNOVER --- %>
                    <td>
                      <% if turnover_from_api %>
                        <div class="fr-badge fr-badge--success fr-badge--sm">Récupéré automatiquement</div>
                        <%= response_form.hidden_field "#{year_key}_turnover" %>
                      <% else %>
                        <div class="fr-input-group">
                          <%= response_form.text_field "#{year_key}_turnover",
                                type: "number",
                                class: "fr-input fr-input--sm",
                                placeholder: "ex: 500000",
                                step: 1,
                                min: 0 %>
                        </div>
                      <% end %>
                    </td>

                    <%# --- MARKET PERCENTAGE --- %>
                    <td>
                      <div class="fr-input-group">
                        <%= response_form.text_field "#{year_key}_market_percentage",
                              type: "number",
                              class: "fr-input fr-input--sm",
                              placeholder: "ex: 75",
                              step: 1,
                              min: 0,
                              max: 100 %>
                      </div>
                    </td>

                    <%# --- FISCAL YEAR END --- %>
                    <td>
                      <% if fiscal_year_end_from_api %>
                        <%= l(Date.parse(value_data[year_key]['fiscal_year_end']), format: '%d/%m/%Y') rescue value_data[year_key]['fiscal_year_end'] %>
                        <span class="fr-icon-checkbox-circle-fill fr-icon--sm fr-ml-1w" style="color: #18753C;" title="Récupéré automatiquement" aria-label="Récupéré automatiquement"></span>
                        <%= response_form.hidden_field "#{year_key}_fiscal_year_end" %>
                      <% else %>
                        <div class="fr-input-group">
                          <%= response_form.text_field "#{year_key}_fiscal_year_end",
                                type: "date",
                                class: "fr-input fr-input--sm" %>
                        </div>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <% if has_errors %>
      <div class="fr-messages-group fr-mt-2w" aria-live="polite">
        <% market_attribute_response.errors[:value].each do |error_message| %>
          <p class="fr-message fr-message--error"><%= error_message %></p>
        <% end %>
      </div>
    <% end %>

    <% %w[year_1 year_2 year_3].each do |year_key| %>
      <% if market_attribute_response.errors[year_key.to_sym].any? %>
        <div class="fr-messages-group fr-mt-1w" aria-live="polite">
          <p class="fr-message fr-message--error">
            <%= t("candidate.market_applications.form_fields.capacite_economique_financiere_chiffre_affaires_global_annuel.year_labels.#{year_key}", default: year_key.humanize) %> :
            <%= market_attribute_response.errors[year_key.to_sym].first %>
          </p>
        </div>
      <% end %>
    <% end %>

  <% end %>
</div>
