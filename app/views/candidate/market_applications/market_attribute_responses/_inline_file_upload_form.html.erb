<%
  required = market_attribute_response.market_attribute.required?
  documents = market_attribute_response.documents
%>

<% if market_attribute_response.auto? %>
  <%# Data filled automatically from API - show indicator but not the value %>
  <%= form.fields_for :market_attribute_responses, market_attribute_response,
                      child_index: market_attribute_response.id do |response_form| %>
    <%= response_form.hidden_field :id %>
    <%= response_form.hidden_field :market_attribute_id %>
    <%= response_form.hidden_field :type %>
  <% end %>

  <div class="fr-mb-2w">
    <label class="fr-label">
      <%= t("form_fields.candidate.fields.#{market_attribute_response.market_attribute.key}.name") %>
      <%= render 'candidate/market_applications/market_attribute_responses/source_badge', market_attribute_response: market_attribute_response %>
    </label>
    <p class="fr-text--sm fr-text--mention-grey">
      <%= t('candidate.market_applications.auto_filled_message') %>
    </p>
  </div>
<% else %>
  <%# Manual input or manual after API failure - show normal form %>
<div class="certificate-row">
  <div class="certificate-col certificate-col--left">
    <h6 class="fr-mb-2w fr-text--md">
      <%= t("form_fields.candidate.fields.#{market_attribute_response.market_attribute.key}.name") %>
    </h6>
    <% if t("form_fields.candidate.fields.#{market_attribute_response.market_attribute.key}.description", default: nil).present? %>
      <span class="fr-mb-2w fr-text--sm">
        <%= t("form_fields.candidate.fields.#{market_attribute_response.market_attribute.key}.description") %>
      </span>
    <% end %>
  </div>
  <div class="certificate-col certificate-col--right">
  <div class="fr-upload-group">
    <%= form.fields_for :market_attribute_responses, market_attribute_response,
                        child_index: market_attribute_response.id,
                        multipart: true do |response_form| %>
      <%= response_form.hidden_field :id %>
      <%= response_form.hidden_field :market_attribute_id %>
      <%= response_form.hidden_field :type %>
      <div class="fr-upload-group fr-mt-2w">
        <span class="fr-hint-text fr-text--sm">
          Taille maximale : <%= MarketAttributeResponse::FileUpload::MAX_FILE_SIZE / 1.megabyte %> Mo.
          Formats supportés : jpg, png, pdf. Plusieurs fichiers possibles.
        </span>
        <%= response_form.file_field :files,
            class: "fr-upload",
            required: required,
            multiple: true,
            accept: ".pdf,.doc,.docx,.jpg,.jpeg,.png",
            id: "upload-#{market_attribute_response.id}" %>
        <% persisted_documents = documents.select(&:persisted?) %>
        <% if persisted_documents.any? %>
          <div class="fr-mt-2w fr-text--sm fr-mb-0">
            <strong>Documents actuels :</strong>
            <% persisted_documents.each do |document| %>
              <div>
                <%= link_to document.filename.to_s, url_for(document), target: "_blank", rel: "noopener" %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="fr-mt-2w fr-text--sm fr-mb-0">
            <strong>Fichiers actuels :</strong>
            <span>Aucun fichier téléchargé</span>
          </div>
        <% end %>
        <div class="fr-messages-group" id="upload-<%= market_attribute_response.id %>-messages" aria-live="polite">
          <% if response_form.object.errors[:documents].present? %>
            <p class="fr-message fr-message--error">
              <%= response_form.object.errors[:documents].first %>
            </p>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
  </div>
</div>
<% end %>
