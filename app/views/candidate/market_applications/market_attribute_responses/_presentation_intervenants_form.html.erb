<%
  key = market_attribute_response.market_attribute.key
%>

<% if market_attribute_response.auto? %>
  <%# Data filled automatically from API - show indicator but not the value %>
  <%= form.fields_for :market_attribute_responses, market_attribute_response,
                      child_index: market_attribute_response.id do |response_form| %>
    <%= response_form.hidden_field :id %>
    <%= response_form.hidden_field :market_attribute_id %>
    <%= response_form.hidden_field :type %>
  <% end %>

  <div class="fr-mb-2w">
    <label class="fr-label">
      <%= t("form_fields.candidate.fields.#{key}.name", default: key.humanize) %>
      <%= render 'candidate/market_applications/market_attribute_responses/source_badge', market_attribute_response: market_attribute_response %>
    </label>
    <p class="fr-text--sm fr-text--mention-grey">
      <%= t('candidate.market_applications.auto_filled_message') %>
    </p>
  </div>
<% else %>
  <%# Manual input or manual after API failure - show normal form %>
<div class="fr-input-group<%= ' fr-input-group--error' if market_attribute_response.errors[:value].any? %>">
  <%= form.fields_for :market_attribute_responses, market_attribute_response do |response_form| %>
    <%= response_form.hidden_field :id %>
    <%= response_form.hidden_field :market_attribute_id %>
    <%= response_form.hidden_field :type %>

    <h6 class="fr-mb-2w fr-text--md">
      <%= t("form_fields.candidate.fields.#{key}.name", default: key.humanize) %>
    </h6>

    <% if t("form_fields.candidate.fields.#{key}.description", default: nil).present? %>
      <div class="fr-hint-text fr-mb-3w fr-text--sm">
        <%= t("form_fields.candidate.fields.#{key}.description") %>
      </div>
    <% end %>

    <div data-controller="nested-form" data-nested-form-wrapper-selector-value=".nested-form-wrapper">
      <div class="fr-mt-4w">
        <h6 class="fr-text--sm fr-mb-2w">Téléchargez une liste des intervenants</h6>
        <%= render partial: 'candidate/market_applications/market_attribute_responses/fields/file_upload_field',
                   locals: {
                     form: response_form,
                     attribute_response: market_attribute_response
                   } %>
      </div>

      <div style="margin-bottom: 2em;"></div>

      <div class="fr-separator fr-mb-2w" style="display: flex; align-items: center;">
        <hr class="fr-hr" style="flex: 1; border: none; border-top: 1px solid var(--border-default-grey); padding: 0;">
        <span style="padding: 0 1em; font-weight: bold;">OU</span>
        <hr class="fr-hr" style="flex: 1; border: none; border-top: 1px solid var(--border-default-grey); padding: 0;">
      </div>

      <div data-nested-form-target="target">
        <%
          persons_data = market_attribute_response.persons_ordered
          persons_with_data = persons_data.select do |_timestamp, person|
            person.present? && person.any? { |_k, v| v.present? }
          end
        %>

        <% persons_with_data.each_with_index do |(timestamp, person), display_index| %>
          <%= render partial: 'candidate/market_applications/market_attribute_responses/person_fields',
                     locals: {
                       response_form: response_form,
                       index: timestamp,
                       market_attribute_response: market_attribute_response,
                       display_number: display_index + 1
                     } %>
        <% end %>
      </div>

      <div class="fr-mb-3w">
        <button type="button"
                class="fr-btn fr-btn--secondary fr-btn--sm fr-icon-add-line fr-btn--icon-left"
                data-action="nested-form#add">
          Ajouter un intervenant manuellement
        </button>
      </div>

      <template data-nested-form-target="template">
        <%= render partial: 'candidate/market_applications/market_attribute_responses/person_fields',
                   locals: {
                     response_form: response_form,
                     index: 'NEW_RECORD',
                     market_attribute_response: market_attribute_response,
                     display_number: nil
                   } %>
      </template>
    </div>

    <% if market_attribute_response.errors[:value].any? %>
      <p class="fr-error-text">
        <%= market_attribute_response.errors[:value].first %>
      </p>
    <% end %>
  <% end %>
</div>
<% end %>
