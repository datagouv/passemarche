<%
  required = market_attribute_response.market_attribute.required?
  documents = market_attribute_response.documents
%>

<div class="fr-upload-group">
  <%= form.fields_for :market_attribute_responses, market_attribute_response,
                      child_index: market_attribute_response.id,
                      multipart: true do |response_form| %>
    <%= response_form.hidden_field :id %>
    <%= response_form.hidden_field :market_attribute_id %>
    <%= response_form.hidden_field :type %>

    <h6 class="fr-mb-2w fr-text--md">
      <%= t("form_fields.candidate.fields.#{market_attribute_response.market_attribute.key}.name") %>
    </h6>

    <% if t("form_fields.candidate.fields.#{market_attribute_response.market_attribute.key}.description", default: nil).present? %>
      <span class="fr-hint-text fr-mb-2w fr-text--sm">
        <%= t("form_fields.candidate.fields.#{market_attribute_response.market_attribute.key}.description") %>
      </span>
    <% end %>

    <div class="fr-upload-group fr-mt-2w fr-card fr-p-2w">
      <%= response_form.label :files, "Ajouter vos documents", class: "fr-label fr-mb-2w fr-text--md", for: "upload-#{market_attribute_response.id}" %>
      <span class="fr-hint-text fr-mb-2w fr-text--sm">
        Taille maximale : <%= MarketAttributeResponse::FileUpload::MAX_FILE_SIZE / 1.megabyte %> Mo.
        Formats supportés : jpg, png, pdf. Plusieurs fichiers possibles.
      </span>
      <%= response_form.file_field :files,
          class: "fr-upload",
          required: required,
          multiple: true,
          accept: ".pdf,.doc,.docx,.jpg,.jpeg,.png",
          id: "upload-#{market_attribute_response.id}" %>

      <% if documents.attached? %>
        <div class="fr-text--sm fr-mb-0">
          <strong>Fichiers actuels :</strong>
          <% documents.each do |doc| %>
            <div>
              <span class="fr-icon--sm fr-icon-file-fill" aria-hidden="true"></span>
              <%= link_to doc.filename.to_s,
                          url_for(doc),
                          target: "_blank", rel: "noopener" %>
              (<%= number_to_human_size(doc.byte_size) %>)
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="fr-text--sm fr-mb-0">
          <strong>Fichiers actuels :</strong>
          <span>Aucun fichier téléchargé</span>
        </div>
      <% end %>
      <div class="fr-messages-group" id="upload-<%= market_attribute_response.id %>-messages" aria-live="polite">
        <% if response_form.object.errors[:documents].present? %>
          <p class="fr-message fr-message--error">
            <%= response_form.object.errors[:documents].first %>
          </p>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
