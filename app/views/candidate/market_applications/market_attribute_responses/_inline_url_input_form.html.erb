<%
  required = market_attribute_response.market_attribute.required?
  text_value = market_attribute_response.text || ''
  key = market_attribute_response.market_attribute.key
  is_opqibi = key == "capacites_techniques_professionnelles_certificats_opqibi"
  is_france_competences = key == "capacites_techniques_professionnelles_certificats_france_competences"
  label_text = t("form_fields.candidate.fields.#{market_attribute_response.market_attribute.key}.name")
%>

<% if market_attribute_response.auto? %>
  <%# Data filled automatically from API %>
  <%= form.fields_for :market_attribute_responses, market_attribute_response,
                      child_index: market_attribute_response.id do |response_form| %>
    <%= response_form.hidden_field :id %>
    <%= response_form.hidden_field :market_attribute_id %>
    <%= response_form.hidden_field :type %>
    <%= response_form.hidden_field :text, value: text_value %>
  <% end %>

  <div class="fr-mb-2w">
    <label class="fr-label">
      <%= label_text %>
      <%= render 'candidate/market_applications/market_attribute_responses/source_badge', market_attribute_response: market_attribute_response %>
    </label>

    <% if market_attribute_response.respond_to?(:opqibi_metadata?) && market_attribute_response.opqibi_metadata? %>
      <%# Special case for OPQIBI: show metadata but not URL %>
      <div class="fr-text--sm fr-text--mention-grey">
        <p class="fr-mb-1v">
          <em>Les informations suivantes ont été récupérées automatiquement depuis l'API OPQIBI :</em>
        </p>
        <% if market_attribute_response.formatted_date_delivrance.present? %>
          <p class="fr-mb-1v">
            <strong>Date de délivrance :</strong>
            <%= l(market_attribute_response.formatted_date_delivrance, format: :long) %>
          </p>
        <% end %>
        <% if market_attribute_response.duree_validite_certificat.present? %>
          <p class="fr-mb-0">
            <strong>Durée de validité :</strong>
            <%= market_attribute_response.duree_validite_certificat %>
          </p>
        <% end %>
      </div>
    <% else %>
      <%# Other auto-filled fields - generic message %>
      <p class="fr-text--sm fr-text--mention-grey">
        <%= t('candidate.market_applications.auto_filled_message') %>
      </p>
    <% end %>
  </div>
<% else %>
  <%# Manual input or manual after API failure %>
  <div class="certificate-row">
    <div class="certificate-col certificate-col--left">
      <h6 class="fr-mb-2w fr-text--md">
        <%= label_text %>
        <%= render 'candidate/market_applications/market_attribute_responses/source_badge', market_attribute_response: market_attribute_response %>
      </h6>
      <% if t("form_fields.candidate.fields.#{market_attribute_response.market_attribute.key}.description", default: nil).present? %>
        <span class="fr-hint-text fr-mb-2w fr-text--sm">
          <%= t("form_fields.candidate.fields.#{market_attribute_response.market_attribute.key}.description") %>
        </span>
      <% end %>
    </div>
    <div class="certificate-col certificate-col--right">
    <div class="fr-input-group">
      <%= form.fields_for :market_attribute_responses, market_attribute_response,
                          child_index: market_attribute_response.id do |response_form| %>
        <%= response_form.hidden_field :id %>
        <%= response_form.hidden_field :market_attribute_id %>
        <%= response_form.hidden_field :type %>

        <%= response_form.label :text, "URL", class: "fr-hint-text fr-text--md fr-mb-1w", for: "certificat-#{market_attribute_response.id}-url" %>
        <%= response_form.text_field :text,
              value: text_value,
              id: "certificat-#{market_attribute_response.id}-url",
              class: "fr-input#{' fr-input--error' if market_attribute_response.errors[:text].any?}",
              required: required %>

        <% if market_attribute_response.errors[:text].any? %>
          <p class="fr-error-text">
            <%= market_attribute_response.errors[:text].first %>
          </p>
        <% end %>
      <% end %>

      <% if is_opqibi %>
        <span class="fr-text--xs fr-text--blue-france" style="display: flex; align-items: center; gap: 0.25em; margin-top: 16px;">
          <i class="fr-icon--sm fr-icon-info-fill" aria-hidden="true"></i>
          Vous pouvez trouver ce certificat via
          <%= link_to "ce lien", "https://www.opqibi.com/recherche-plus", target: "_blank", rel: "noopener" %>
        </span>
      <% elsif is_france_competences %>
        <span class="fr-text--xs fr-text--blue-france" style="display: flex; align-items: center; gap: 0.25em; margin-top: 16px;">
          <i class="fr-icon--sm fr-icon-info-fill" aria-hidden="true"></i>
          Vous pouvez trouver ce certificat via
          <%= link_to "ce lien", "https://www.francecompetences.fr/recherche-resultats/", target: "_blank", rel: "noopener" %>
        </span>
      <% end %>
    </div>
    </div>
  </div>
<% end %>
<hr class="fr-hr">
