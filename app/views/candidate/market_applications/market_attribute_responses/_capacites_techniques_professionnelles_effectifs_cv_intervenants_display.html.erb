<%
  persons_data = market_attribute_response.persons
  key = market_attribute_response.market_attribute.key
  has_persons = persons_data.present? && persons_data.values.any? { |person| person.present? && person.any? { |_, v| v.present? } }
  documents = market_attribute_response.generic_documents
%>

<div class="field-layout-container">
  <div class="field-layout-content">
    <strong>
      <%= t("form_fields.candidate.fields.#{key}.name", default: key.humanize) %>
    </strong>
    <br>

    <% if has_persons %>
      <div class="fr-mt-2w">
        <% market_attribute_response.persons_ordered.each_with_index do |(timestamp, person), index| %>
          <% next if person.blank? || person.all? { |_, v| v.blank? } %>

          <div class="fr-card fr-card--sm fr-mb-2w">
            <div class="fr-card__body">
              <div class="fr-card__content">
                <h6 class="fr-text--sm fr-mb-1w">
                  <span class="fr-icon-user-line fr-icon--sm fr-mr-1v" aria-hidden="true"></span>
                  Personne <%= index + 1 %>
                </h6>

                <% if person['nom'].present? %>
                  <div class="fr-mb-1v">
                    <strong>Nom :</strong> <%= person['nom'] %>
                  </div>
                <% end %>

                <% if person['prenoms'].present? %>
                  <div class="fr-mb-1v">
                    <strong>Prénoms :</strong> <%= person['prenoms'] %>
                  </div>
                <% end %>

                <% if person['titres'].present? %>
                  <div class="fr-mb-1v">
                    <strong>Titres :</strong> <%= person['titres'] %>
                  </div>
                <% end %>

                <% if person['cv_attachment_id'].present? %>
                  <% cv_attachment = market_attribute_response.person_cv_attachment(timestamp) %>
                  <% if cv_attachment %>
                    <div class="fr-mb-1v">
                      <strong>CV :</strong>
                      <span class="fr-icon-file-fill fr-icon--sm fr-mr-1v" aria-hidden="true"></span>
                      <%= link_to cv_attachment.filename.to_s,
                                  url_for(cv_attachment),
                                  target: "_blank", rel: "noopener",
                                  class: "fr-link" %>
                      (<%= number_to_human_size(cv_attachment.byte_size) %>)
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <span class="fr-text--sm fr-text--mention-grey">Aucune personne renseignée</span>
    <% end %>

    <!-- Display attached documents if any -->
    <% if documents.any? %>
      <div class="fr-mt-3w">
        <h6 class="fr-text--sm fr-mb-1w">Documents associés</h6>
        <div class="fr-text--sm fr-text--mention-grey">
          <% documents.each do |doc| %>
            <div class="fr-mb-1v">
              <span class="fr-icon-file-fill fr-icon--sm fr-mr-1v" aria-hidden="true"></span>
              <%= link_to doc.filename.to_s,
                          url_for(doc),
                          target: "_blank", rel: "noopener",
                          class: "fr-link" %>
              (<%= number_to_human_size(doc.byte_size) %>)
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>