<%
  realisations_data = market_attribute_response.realisations
  key = market_attribute_response.market_attribute.key
  has_realisations = realisations_data.present? && realisations_data.values.any? { |realisation| realisation.present? && realisation.any? { |_, v| v.present? } }
  context ||= :web
  show_value = !market_attribute_response.auto? || context == :buyer
  market_application = market_attribute_response.market_application
%>

<div class="field-layout-container">
  <div class="field-layout-content">
    <strong>
      <%= t("form_fields.candidate.fields.#{key}.name", default: key.humanize) %>
      <%= render 'candidate/market_applications/market_attribute_responses/source_badge', market_attribute_response: market_attribute_response %>
    </strong>

    <% if show_value %>
      <br>

      <% if has_realisations %>
        <div class="fr-mt-2w">
          <% market_attribute_response.realisations_ordered.each_with_index do |(timestamp, realisation), index| %>
            <% next if realisation.blank? || realisation.all? { |_, v| v.blank? } %>

            <div class="fr-card fr-card--sm fr-mb-2w">
              <div class="fr-card__body">
                <div class="fr-card__content">
                  <h6 class="fr-text--sm fr-mb-1w">
                    <span class="fr-icon-building-line fr-icon--sm fr-mr-1v" aria-hidden="true"></span>
                    Réalisation <%= index + 1 %>
                  </h6>

                  <% if realisation['resume'].present? %>
                    <div class="fr-mb-1v">
                      <strong>Résumé :</strong> <%= realisation['resume'] %>
                    </div>
                  <% end %>

                  <% if realisation['date_debut'].present? || realisation['date_fin'].present? %>
                    <div class="fr-mb-1v">
                      <strong>Période :</strong>
                      <% if realisation['date_debut'].present? %>
                        Du <%= l(Date.parse(realisation['date_debut']), format: :long) %>
                      <% end %>
                      <% if realisation['date_fin'].present? %>
                        au <%= l(Date.parse(realisation['date_fin']), format: :long) %>
                      <% end %>
                    </div>
                  <% end %>

                  <% if realisation['montant'].present? %>
                    <div class="fr-mb-1v">
                      <strong>Montant :</strong> <%= number_to_currency(realisation['montant'], unit: '€', separator: ',', delimiter: ' ', format: '%n %u', precision: 0) %>
                    </div>
                  <% end %>

                  <% if realisation['description'].present? %>
                    <div class="fr-mb-1v">
                      <strong>Description :</strong><br>
                      <%= simple_format(realisation['description'], class: 'fr-text--sm') %>
                    </div>
                  <% end %>

                  <% if realisation['attestation_bonne_execution'].present? %>
                    <% attestations = market_attribute_response.realisation_attestations(timestamp) %>
                    <% if attestations.any? %>
                      <div class="fr-mb-1v">
                        <strong><%= attestations.size == 1 ? 'Attestation' : 'Attestations' %> :</strong>
                        <ul class="fr-text--sm fr-mt-1v">
                          <% attestations.each do |attestation| %>
                            <li>
                              <%= render 'candidate/market_applications/market_attribute_responses/shared/document_item',
                                         document: attestation,
                                         market_application: market_application,
                                         context: context %>
                            </li>
                          <% end %>
                        </ul>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <span class="fr-text--md fr-text--mention-grey">Aucune réalisation renseignée</span>
      <% end %>
    <% end %>
  </div>
</div>
