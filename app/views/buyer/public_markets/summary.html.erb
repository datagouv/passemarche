<% content_for :title, "#{@public_market.editor.name} - #{t('buyer.summary.title_suffix')}" %>

<div class="fr-grid-row fr-grid-row--gutters">
  <div class="fr-col-12">
    <%= stepper(
      current_step: step,
      steps: @wizard_steps,
      i18n_scope: 'buyer'
    ) %>
  </div>
</div>

<div class="fr-grid-row fr-grid-row--center">
  <div class="fr-col-12">
    <div class="fr-mb-4w">
      <div class="fr-card fr-mb-4w">
        <div class="fr-card__header">
          <h2 class="fr-card__title fr-mb-0 fr-py-3w fr-px-4w fr-background-alt--grey">
            <%= t('buyer.summary.market_info_title') %>
          </h2>
        </div>
        <div class="fr-card__body fr-pt-4w fr-pb-4w">
          <div class="fr-mb-3w">
            <div class="fr-text--bold fr-mb-1w"><%= t('buyer.shared.market_name') %></div>
            <div><%= @public_market.name %></div>
          </div>
          <% if @public_market.lot_name.present? %>
            <div class="fr-mb-3w">
              <div class="fr-text--bold fr-mb-1w"><%= t('buyer.shared.lot_name') %></div>
              <div><%= @public_market.lot_name %></div>
            </div>
          <% end %>
          <div class="fr-mb-3w">
            <div class="fr-text--bold fr-mb-1w"><%= t('buyer.shared.deadline_short') %></div>
            <div><%= l(@public_market.deadline, format: '%d/%m/%Y %H:%M') %> (heure de Paris)</div>
          </div>
          <div class="fr-mb-3w">
            <div class="fr-text--bold fr-mb-1w"><%= t('buyer.shared.market_type_short') %></div>
            <div>
            <% if @public_market.market_type_codes.any? %>
              <% @public_market.market_type_codes.each do |market_type_code| %>
                <span class="fr-badge fr-badge--sm fr-mr-1w">
                  <%= t("market_types.#{market_type_code}", default: market_type_code.humanize) %>
                </span>
              <% end %>
            <% else %>
              <p class="fr-text--sm fr-mb-0"><%= t('buyer.shared.no_market_type') %></p>
            <% end %>
            </div>
          </div>
          <div>
            <div class="fr-text--bold fr-mb-1w"><%= t('buyer.shared.identifier') %></div>
            <div><code><%= @public_market.identifier %></code></div>
          </div>
        </div>
      </div>
    </div>

    <div class="fr-mb-4w">
      <div class="fr-mb-4w">
        <% fields_by_category = @presenter.selected_fields_by_category_and_subcategory %>
        <%# Build ordered categories list following wizard steps order %>
        <%# For motifs_exclusion: always show if it's a step (even without optional fields) %>
        <% display_categories = [] %>
        <% @wizard_steps.each do |wizard_step| %>
          <% category = wizard_step.to_s %>
          <% next if %w[setup summary].include?(category) %>
          <% if category == 'motifs_exclusion' %>
            <% display_categories << [category, fields_by_category[category] || {}] %>
          <% elsif fields_by_category.key?(category) %>
            <% display_categories << [category, fields_by_category[category]] %>
          <% end %>
        <% end %>

        <% if display_categories.any? %>
          <% display_categories.each_with_index do |(category, subcategories), category_index| %>
            <h2 class="fr-h2 fr-mb-3w <%= 'fr-mt-8w' if category_index > 0 %>" style="color: var(--background-action-high-blue-france);">
              <%= category_index + 1 %>. <%= t("form_fields.buyer.categories.#{category}", default: category.humanize) %>
            </h2>
            <div class="fr-card fr-mb-4w">
              <div class="fr-card__body fr-mt-3w fr-mb-3w">
                <% if category == 'motifs_exclusion' %>
                  <%# Mandatory attestation section %>
                  <div class="fr-p-3w" style="background-color: var(--background-alt-grey);">
                    <h4 class="fr-h6 fr-mb-2w"><%= t('buyer.public_markets.generic_step.steps.motifs_exclusion.box_title') %></h4>
                    <p class="fr-mb-0 fr-text--sm"><%= t('buyer.public_markets.generic_step.steps.motifs_exclusion.box_content_html') %></p>
                  </div>

                  <% optional_subcategories = subcategories.transform_values { |fields| fields.select { |key| !@presenter.field_by_key(key)&.mandatory } }.reject { |_, fields| fields.empty? } %>
                  <% if optional_subcategories.any? %>
                    <h4 class="fr-h6 fr-mb-2w fr-mt-3w"><%= t('buyer.public_markets.generic_step.steps.motifs_exclusion.optional_fields_title') %></h4>
                    <% optional_subcategories.each_with_index do |(subcategory, fields), subcat_index| %>
                      <%= render 'subcategory_section',
                            subcategory: subcategory,
                            subcategories: optional_subcategories,
                            table_mode: true,
                            is_last: (subcat_index == optional_subcategories.size - 1) do %>
                        <ul class="fr-list <%= 'fr-mb-3w' if @presenter.display_sidemenu?(optional_subcategories) %>">
                          <% fields.each do |field_key| %>
                            <% field = @presenter.field_by_key(field_key) %>
                            <%= render 'field_display',
                                  field_key: field_key,
                                  field: field,
                                  html_tag: :li,
                                  wrapper_classes: 'fr-list__item' %>
                          <% end %>
                        </ul>
                      <% end %>
                    <% end %>
                  <% end %>
                <% else %>
                  <% subcategories.each_with_index do |(subcategory, fields), subcat_index| %>
                    <%= render 'subcategory_section',
                          subcategory: subcategory,
                          subcategories: subcategories,
                          table_mode: true,
                          is_last: (subcat_index == subcategories.size - 1) do %>
                      <ul class="fr-list <%= 'fr-mb-3w' if @presenter.display_sidemenu?(subcategories) %>">
                        <% fields.each do |field_key| %>
                          <% field = @presenter.field_by_key(field_key) %>
                          <%= render 'field_display',
                                field_key: field_key,
                                field: field,
                                html_tag: :li,
                                wrapper_classes: 'fr-list__item' %>
                        <% end %>
                      </ul>
                    <% end %>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        <% else %>
          <p class="fr-text--sm fr-text--mention-grey"><%= t('buyer.summary.no_fields_configured') %></p>
        <% end %>
      </div>
    </div>

    <div class="fr-mb-4w">
      <%= form_with model: @public_market, url: wizard_path, local: true, data: { turbo: false } do |form| %>
        <div class="fr-btns-group fr-btns-group--right fr-btns-group--inline">
          <%= link_to previous_wizard_path, class: "fr-btn fr-btn--secondary" do %>
            <%= t('buyer.shared.previous') %>
          <% end %>
          <%= form.submit t('buyer.summary.finalize'), class: "fr-btn fr-btn--lg fr-btn--success" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
