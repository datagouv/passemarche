<% content_for :title, "#{@public_market.editor.name} - Synthèse de ma candidature" %>

<div class="fr-grid-row fr-grid-row--center">
  <div class="fr-col-12 fr-col-lg-10">
    <div class="fr-mb-6w">
      <h1 class="fr-h1 fr-mb-2w">Synthèse de ma candidature</h1>
      <p class="fr-text--lg fr-mb-0">
        Vérifiez les paramètres de votre marché avant de finaliser la configuration.
      </p>
    </div>

    <div class="fr-mb-4w">
      <div class="fr-card fr-mb-4w">
        <div class="fr-card__header">
          <h2 class="fr-card__title fr-mb-0 fr-py-3w fr-px-4w" style="background-color: var(--background-action-high-blue-france); color: white; font-weight: bold;">
            Informations du marché
          </h2>
        </div>
        <div class="fr-card__body">
          <div class="fr-p-4w">
            <div class="fr-mb-3w">
              <div class="fr-text--bold fr-mb-1w">Nom du marché</div>
              <div><%= @public_market.market_name %></div>
            </div>
            <% if @public_market.lot_name.present? %>
              <div class="fr-mb-3w">
                <div class="fr-text--bold fr-mb-1w">Nom du lot</div>
                <div><%= @public_market.lot_name %></div>
              </div>
            <% end %>
            <div class="fr-mb-3w">
              <div class="fr-text--bold fr-mb-1w">Date limite</div>
              <div><%= l(@public_market.deadline, format: '%d/%m/%Y %H:%M') %> (heure de Paris)</div>
            </div>
            <div class="fr-mb-3w">
              <div class="fr-text--bold fr-mb-1w">Type de marché</div>
              <div>
                <%= @public_market.market_type %>
                <% if @public_market.defense_industry == true %>
                  <span class="fr-badge fr-badge--warning fr-ml-1w">Défense</span>
                <% end %>
              </div>
            </div>
            <div>
              <div class="fr-text--bold fr-mb-1w">Identifiant</div>
              <div><code><%= @public_market.identifier %></code></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="fr-mb-4w">
      <div class="fr-mb-4w">
        <% fields_by_category = @presenter.all_fields_by_category_and_subcategory %>
        <% if fields_by_category.any? %>
          <div>
            <% fields_by_category.each do |category, subcategories| %>
              <div class="fr-card fr-mb-4w">
                <div class="fr-card__header">
                  <h4 class="fr-card__title fr-mb-0 fr-py-3w fr-px-4w" style="background-color: var(--background-action-high-blue-france); color: white; font-weight: bold;">
                    <%= t("form_fields.categories.#{category}") %>
                  </h4>
                </div>
                <div class="fr-card__body fr-mt-3w fr-mb-3w">
                  <% subcategories.each_with_index do |(subcategory, fields), subcat_index| %>
                    <div class="<%= 'fr-mb-3w' unless subcat_index == subcategories.size - 1 %>">
                      <div class="fr-background-alt--grey fr-pl-6v fr-pr-6v fr-pt-4v fr-pb-4v">
                        <% if @presenter.should_display_subcategory?(subcategories) %>
                          <h5 class="fr-text--lg fr-text--bold fr-mb-2w"><%= t("form_fields.subcategories.#{subcategory}") %></h5>
                        <% end %>
                        <ul class="fr-list <%= 'fr-mb-3w' if @presenter.should_display_subcategory?(subcategories) %>">
                          <% fields.each do |field_key| %>
                            <% field = @presenter.field_by_key(field_key) %>
                            <% source_type = field&.source_type %>
                            <li class="fr-list__item fr-pt-4v fr-pb-4v">
                              <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                                <div style="flex: 1; margin-right: 1rem;">
                                  <strong><%= t("form_fields.fields.#{field_key}.name") %></strong>
                                  <br>
                                  <span class="fr-text--sm fr-text--mention-grey"><%= t("form_fields.fields.#{field_key}.description") %></span>
                                </div>
                                <div style="flex-shrink: 0;">
                                  <% if field && source_type %>
                                    <% source_info = field.source_info %>
                                    <span class="fr-badge <%= source_info[:badge_class] %>">
                                      <%= source_info[:label] %>
                                    </span>
                                  <% end %>
                                </div>
                              </div>
                            </li>
                          <% end %>
                        </ul>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="fr-text--sm fr-text--mention-grey">Aucun champ configuré.</p>
        <% end %>
      </div>
    </div>

    <div class="fr-mb-4w">
      <%= form_with model: @public_market, url: wizard_path, local: true, data: { turbo: false } do |form| %>
        <%= form.submit "Finaliser la configuration", class: "fr-btn fr-btn--lg fr-btn--success", disabled: true %>
      <% end %>
      
      <p class="fr-text--sm fr-mt-2w fr-text--mention-grey">
        <span class="fr-icon-information-line fr-mr-1w" aria-hidden="true"></span>
        Bouton temporairement désactivé - fonctionnalité en cours de développement
      </p>
    </div>
  </div>
</div>
