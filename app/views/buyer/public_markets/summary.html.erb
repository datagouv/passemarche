<% content_for :title, "#{@public_market.editor.name} - Synthèse de ma candidature" %>

<div class="fr-grid-row fr-grid-row--gutters">
  <div class="fr-col-12">
    <div class="fr-stepper">
      <h2 class="fr-stepper__title">
        <%= t('buyer.public_markets.steps.summary') %>
        <span class="fr-stepper__state">Étape 3 sur 3</span>
      </h2>
      <div class="fr-stepper__steps" data-fr-current-step="3" data-fr-steps="3">
      </div>
    </div>
  </div>
</div>

<div class="fr-grid-row fr-grid-row--center">
  <div class="fr-col-12 fr-col-lg-10">
    <div class="fr-mb-6w">
      <h1 class="fr-h1 fr-mb-2w">Synthèse de ma candidature</h1>
      <p class="fr-text--lg fr-mb-0">
        Vérifiez les paramètres de votre marché avant de finaliser la configuration.
      </p>
    </div>

    <div class="fr-mb-4w">
      <div class="fr-card fr-mb-4w">
        <div class="fr-card__header">
          <h2 class="fr-card__title fr-mb-0 fr-py-3w fr-px-4w" style="background-color: var(--background-action-high-blue-france); color: white; font-weight: bold;">
            Informations du marché
          </h2>
        </div>
        <div class="fr-card__body">
          <div class="fr-p-4w">
            <div class="fr-mb-3w">
              <div class="fr-text--bold fr-mb-1w">Nom du marché</div>
              <div><%= @public_market.name %></div>
            </div>
            <% if @public_market.lot_name.present? %>
              <div class="fr-mb-3w">
                <div class="fr-text--bold fr-mb-1w">Nom du lot</div>
                <div><%= @public_market.lot_name %></div>
              </div>
            <% end %>
            <div class="fr-mb-3w">
              <div class="fr-text--bold fr-mb-1w">Date limite</div>
              <div><%= l(@public_market.deadline, format: '%d/%m/%Y %H:%M') %> (heure de Paris)</div>
            </div>
            <div class="fr-mb-3w">
              <div class="fr-text--bold fr-mb-1w">Type de marché</div>
              <div>
                <% @public_market.market_type_codes.each do |market_type_code| %>
                  <span class="fr-badge fr-badge--<%= market_type_code == 'defense' ? 'warning' : 'info' %> fr-ml-1w">
                    <%= t("market_types.#{market_type_code}", default: market_type_code.humanize) %>
                  </span>
                <% end %>
                <% if @public_market.market_type_codes.empty? %>
                  <span class="fr-text--sm">Aucun type de marché défini</span>
                <% end %>
              </div>
            </div>
            <div>
              <div class="fr-text--bold fr-mb-1w">Identifiant</div>
              <div><code><%= @public_market.identifier %></code></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="fr-mb-4w">
      <div class="fr-mb-4w">
        <% fields_by_category = @presenter.all_fields_by_category_and_subcategory %>
        <% if fields_by_category.any? %>
          <div>
            <% fields_by_category.each do |category, subcategories| %>
              <div class="fr-card fr-mb-4w">
                <%= render 'card_header', title: t("form_fields.categories.#{category}") %>
                <div class="fr-card__body fr-mt-3w fr-mb-3w">
                  <% subcategories.each_with_index do |(subcategory, fields), subcat_index| %>
                    <%= render 'subcategory_section', 
                          subcategory: subcategory, 
                          subcategories: subcategories, 
                          is_last: (subcat_index == subcategories.size - 1) do %>
                      <ul class="fr-list <%= 'fr-mb-3w' if @presenter.should_display_subcategory?(subcategories) %>">
                        <% fields.each do |field_key| %>
                          <% field = @presenter.field_by_key(field_key) %>
                          <%= render 'field_display', 
                                field_key: field_key, 
                                field: field, 
                                html_tag: :li, 
                                wrapper_classes: 'fr-list__item' %>
                        <% end %>
                      </ul>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="fr-text--sm fr-text--mention-grey">Aucun champ configuré.</p>
        <% end %>
      </div>
    </div>

    <div class="fr-mb-4w">
      <%= form_with model: @public_market, url: wizard_path, local: true, data: { turbo: false } do |form| %>
        <div class="fr-btns-group fr-btns-group--right fr-btns-group--inline">
          <%= link_to previous_wizard_path, class: "fr-btn fr-btn--secondary" do %>
            Précédent
          <% end %>
          <%= form.submit "Finaliser la configuration", class: "fr-btn fr-btn--lg fr-btn--success", disabled: true %>
        </div>
      <% end %>
      
      <p class="fr-text--sm fr-mt-2w fr-text--mention-grey">
        <span class="fr-icon-information-line fr-mr-1w" aria-hidden="true"></span>
        Bouton temporairement désactivé - fonctionnalité en cours de développement
      </p>
    </div>
  </div>
</div>
