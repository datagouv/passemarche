<% content_for :title, "#{@public_market.editor.name} - Synchronisation" %>

<div class="fr-grid-row fr-grid-row--gutters" style="min-height: 70vh;">
  <div class="fr-col-12 fr-col-lg-7" style="display: flex; align-items: center;">
    <div class="fr-mb-4w" 
         data-controller="sync-status" 
         data-sync-status-url-value="<%= buyer_sync_status_path(@public_market.identifier, format: :json) %>"
         data-sync-status-redirect-url-value="<%= @public_market.editor.redirect_url&.gsub('{market_identifier}', @public_market.identifier) %>"
         data-status="<%= @public_market.sync_status %>">
      
      <div id="sync-status-content">
        <% if @public_market.sync_completed? %>
          <div>
            <h3 class="fr-h3">Synchronisation réussie</h3>
            <p>
              Nous avons transmis automatiquement la configuration à votre profil acheteur, les entreprises pourront candidater via <%= @public_market.editor.name %>. 
            </p>
            <div class="fr-text--sm" data-controller="clipboard">
              Voici l'identifiant du marché à conserver : 
              <br />
              <span class="fr-text--bold fr-text--md" data-clipboard-target="text"><%= @public_market.identifier %></span>
              <button type="button" 
                      class="fr-btn fr-btn--sm fr-btn--secondary fr-icon-clipboard-line fr-btn--icon-left fr-ml-2w"
                      data-action="click->clipboard#copy"
                      data-clipboard-target="button"
                      title="Copier l'identifiant">
                Copier
              </button>
            </div>
            <div class="fr-btns-group fr-btns-group--inline fr-mt-3w">
              <%= link_to "Retourner sur #{@public_market.editor.name}", 
                          @public_market.editor.redirect_url&.gsub('{market_identifier}', @public_market.identifier) || root_path,
                          class: 'fr-btn' %>
            </div>
          </div>
        
        <% elsif @public_market.sync_failed? %>
          <div>
            <h3 class="fr-h3">Erreur inattendue</h3>
            <p>
              Désolée, lorem ipsum rencontre un problème, nous n'avons pas réussi à transmettre les informations au profil acheteur.
            </p>
            <p class="fr-text--sm">
              Vous pouvez tenter de transférer à nouveau les informations en cliquant sur le bouton ci-dessous. Si vous avez besoin d'une aide immédiate, merci de nous contacter.
            </p>
            <div class="fr-btns-group fr-btns-group--inline fr-mt-3w">
              <%= button_to "Transmettre le formulaire", 
                          retry_sync_buyer_public_market_path(@public_market.identifier),
                          method: :post,
                          class: "fr-btn",
                          data: { turbo: false } %>
              <%= link_to "Contactez-nous", 
                          "mailto:support@voie-rapide.gouv.fr?subject=Erreur de synchronisation pour le marché #{@public_market.identifier}",
                          class: "fr-btn fr-btn--secondary" %>
            </div>
          </div>
        <% else %>
          <div>
            <h3 class="fr-h3">Synchronisation en cours</h3>
            <p>
              Votre marché est en cours de synchronisation avec <%= @public_market.editor.name %>.
              Cette opération permet de finaliser la configuration et de préparer l'accès
              pour les candidats.
            </p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="fr-col-12 fr-col-lg-1"></div>

  <div class="fr-col-12 fr-col-lg-4" style="display: flex; align-items: center; justify-content: center;">
    <div class="center-content">
      <% if @public_market.sync_completed? %>
        <%= image_tag "sync_status_success.png", alt: "Synchronisation réussie" %>
      <% elsif @public_market.sync_failed? %>
        <%= image_tag "sync_status_error.png", alt: "Erreur de synchronisation" %>
      <% else %>
        <div class="sync-loader" 
             role="img" 
             aria-label="Synchronisation en cours..."
             data-sync-status-target="loader">
        </div>
      <% end %>
    </div>
  </div>
</div>
