<%
  # Shared partial for displaying market application summary
  # Used in both web summary page and PDF attestations
  #
  # Required locals:
  #   market_application - MarketApplication instance
  #   presenter - MarketApplicationPresenter instance
  #   context - :web, :pdf, or :buyer (optional, defaults to :web)

  context ||= :web
%>

<% category_keys = presenter.category_keys_with_attestation_motifs_exclusion %>

<% if category_keys.any? %>
  <% category_keys.each_with_index do |category, index| %>
    <% if category == :attestation_motifs_exclusion %>
      <div class="fr-card fr-mb-2w category-card <%= page_break_class(context, index) %>">
        <%= render 'shared/card_header', title: t("candidate.market_applications.attestation_motifs_exclusion.header_title"), background: "fr-background-alt--grey" %>
        <div class="fr-card__body fr-mt-1w fr-mb-1w">
          <%= render 'shared/candidate_attestation_motifs_exclusion',
                    market_application: market_application,
                    context: context %>
        </div>
      </div>
    <% end %>

    <% subcategories = presenter.subcategories_for_category(category) %>
    <% next if subcategories.empty? %>

    <div class="fr-card fr-mb-2w category-card <%= page_break_class(context, index) %>">
      <%= render 'shared/card_header', title: category_label(category, role: :candidate), background: "fr-background-alt--grey" %>
      <div class="fr-card__body fr-mt-1w fr-mb-1w">
        <% if context == :web && category == 'motifs_exclusion' && presenter.missing_mandatory_motifs_exclusion? %>
          <div class="fr-mt-2w">
            <%= render 'shared/notice',
                        notice_text: t('candidate.market_applications.summary.missing_mandatory_motifs_exclusion_banner'),
                        color: 'error' %>
          </div>
        <% end %>

        <% if category == 'identite_entreprise' %>
          <%= render 'shared/market_info_summary', market_application: market_application %>
        <% end %>

        <% subcategories.each do |subcategory| %>
          <% market_attributes = presenter.market_attributes_for_subcategory(category, subcategory) %>
          <% next if market_attributes.empty? %>

          <%= render 'shared/subcategory_attributes',
                     presenter: presenter,
                     subcategory: subcategory,
                     market_attributes: market_attributes,
                     context: context %>
        <% end %>
      </div>
    </div>
  <% end %>
<% else %>
  <p class="fr-text--md fr-text--mention-grey"><%= t('shared.application_summary.no_documents_configured') %></p>
<% end %>

<%= render 'shared/renamed_documents_section',
           market_application: market_application,
           context: context %>
